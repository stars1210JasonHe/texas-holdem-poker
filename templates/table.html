{% extends "base.html" %}

{% block title %}å¾·å·æ‰‘å…‹æ¸¸æˆ - ç‰Œæ¡Œ{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 py-4">
    <div class="max-w-7xl mx-auto px-4">
        <!-- ç‰Œæ¡Œä¿¡æ¯æ  -->
        <div class="bg-gray-800 rounded-xl p-4 mb-4 border border-gray-700">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-white" id="tableTitle">ç‰Œæ¡Œ</h1>
                    <p class="text-gray-300 text-sm">
                        <span id="gameModeInfo">ç›²æ³¨: <span id="blindInfo">10/20</span></span> | 
                        åº•æ± : <span id="potAmount">0</span> | 
                        æ‰‹ç‰Œ: <span id="handNumber">0</span>
                    </p>
                </div>
                <div class="flex space-x-2">
                    <button id="startHandBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm hidden">
                        å¼€å§‹æ¸¸æˆ
                    </button>
                    <button id="addBotBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                        ğŸ¤– æ·»åŠ æœºå™¨äºº
                    </button>
                    <button id="leaveTableBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                        ç¦»å¼€ç‰Œæ¡Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <!-- å…¬å…±ç‰ŒåŒºåŸŸ -->
            <div class="text-center mb-8">
                <h3 class="text-lg font-semibold text-white mb-4">å…¬å…±ç‰Œ</h3>
                <div id="communityCards" class="flex justify-center space-x-2 mb-4">
                    <!-- å…¬å…±ç‰Œå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="text-xl font-bold text-yellow-400">
                    åº•æ± : $<span id="potDisplay">0</span>
                </div>
            </div>

            <!-- ç©å®¶åŒºåŸŸ -->
            <div id="playersArea" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <!-- ç©å®¶ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <!-- æ‚¨çš„æ‰‹ç‰Œ -->
            <div class="bg-gray-700 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-semibold text-white mb-2">æ‚¨çš„æ‰‹ç‰Œ</h3>
                <div id="myCards" class="flex space-x-2">
                    <!-- æ‰‹ç‰Œå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div id="actionButtons" class="bg-gray-700 rounded-lg p-4 hidden">
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="foldBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        å¼ƒç‰Œ
                    </button>
                    <button id="checkBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded hidden">
                        è¿‡ç‰Œ
                    </button>
                    <button id="callBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded hidden">
                        è·Ÿæ³¨ $<span id="callAmount">0</span>
                    </button>
                    <button id="betBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">
                        ä¸‹æ³¨
                    </button>
                    <button id="raiseBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded hidden">
                        åŠ æ³¨
                    </button>
                    <button id="allinBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                        å…¨ä¸‹
                    </button>
                </div>
                
                <!-- ä¸‹æ³¨è¾“å…¥ -->
                <div id="betInputArea" class="mt-4 text-center hidden">
                    <input 
                        type="number" 
                        id="betAmount" 
                        class="bg-gray-600 text-white px-3 py-2 rounded mr-2"
                        placeholder="è¾“å…¥é‡‘é¢"
                        min="1"
                    >
                    <button id="confirmBetBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        ç¡®è®¤
                    </button>
                    <button id="cancelBetBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>

            <!-- ä¸‹ä¸€è½®æŠ•ç¥¨åŒºåŸŸ -->
            <div id="nextRoundVote" class="bg-yellow-600 rounded-lg p-4 mt-4 hidden">
                <h3 class="text-lg font-semibold text-white mb-2">å‡†å¤‡å¼€å§‹ä¸‹ä¸€è½®ï¼Ÿ</h3>
                <div class="mb-3">
                    <p class="text-white text-sm" id="voteStatus">ç­‰å¾…ç©å®¶æŠ•ç¥¨...</p>
                    <div class="text-xs text-yellow-100 mt-1" id="votedPlayers"></div>
                </div>
                <button id="voteNextRoundBtn" class="bg-white hover:bg-gray-100 text-yellow-600 px-6 py-2 rounded font-bold transition-colors w-full">
                    å¼€å§‹ä¸‹ä¸€è½®
                </button>
            </div>

            <!-- æ¸¸æˆçŠ¶æ€è°ƒè¯• -->
            <div class="bg-gray-700 rounded-lg p-4 mt-4">
                <h3 class="text-lg font-semibold text-white mb-2">æ¸¸æˆçŠ¶æ€ 
                    <button id="refreshStateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs ml-2">
                        åˆ·æ–°
                    </button>
                </h3>
                <div id="gameStateInfo" class="text-sm text-gray-300">
                    <div class="text-gray-500">ç‚¹å‡»åˆ·æ–°æŸ¥çœ‹çŠ¶æ€</div>
                </div>
            </div>

            <!-- æ“ä½œè®°å½• -->
            <div class="bg-gray-700 rounded-lg p-4 mt-4">
                <h3 class="text-lg font-semibold text-white mb-2">æ“ä½œè®°å½•</h3>
                <div id="actionLog" class="max-h-40 overflow-y-auto text-sm text-gray-300">
                    <div class="text-gray-500">æš‚æ— æ“ä½œè®°å½•</div>
                </div>
            </div>

            <!-- ä¸ªäººå†å²è®°å½• -->
            <div class="bg-gray-700 rounded-lg p-4 mt-4">
                <h3 class="text-lg font-semibold text-white mb-2">ä¸ªäººè®°å½•
                    <button id="viewHistoryBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm ml-2">
                        ğŸ“Š æŸ¥çœ‹å†å²
                    </button>
                </h3>
                <div id="playerStats" class="text-sm text-gray-300">
                    <div class="text-gray-500">ç‚¹å‡»æŸ¥çœ‹å†å²è®°å½•åŠ è½½ä¸ªäººç»Ÿè®¡</div>
                </div>
            </div>


        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let tableId = '{{ table_id }}';
    let currentTableState = null;
    let myPlayerId = null;
    let actionLog = [];

    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ¯ DOMContentLoaded äº‹ä»¶è§¦å‘');
        
        // æ£€æŸ¥ç©å®¶ç™»å½•çŠ¶æ€
        const savedPlayer = localStorage.getItem('poker_player');
        if (!savedPlayer) {
            console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ç©å®¶ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°é¦–é¡µ');
            location.href = '/';
            return;
        }

        console.log('âœ… æ‰¾åˆ°ç©å®¶ä¿¡æ¯:', savedPlayer);
        currentPlayer = JSON.parse(savedPlayer);
        myPlayerId = currentPlayer.id;
        updatePlayerInfo();

        // æµ‹è¯•Socketè¿æ¥
        console.log('ğŸ”Œ SocketçŠ¶æ€:', socket ? 'socketå¯¹è±¡å­˜åœ¨' : 'socketå¯¹è±¡ä¸å­˜åœ¨');
        console.log('ğŸ”Œ Socketè¿æ¥çŠ¶æ€:', socket ? socket.connected : 'N/A');

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        console.log('ğŸ“¡ åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');
        initEventListeners();
        
        // è¿æ¥åˆ°ç‰Œæ¡Œ
        console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼Œç©å®¶ä¿¡æ¯:', { myPlayerId, currentPlayer });
        connectToTable();
        
        // æµ‹è¯•ç©å®¶æ˜¾ç¤ºåŒºåŸŸ
        const playersArea = document.getElementById('playersArea');
        console.log('ğŸ‘¥ ç©å®¶æ˜¾ç¤ºåŒºåŸŸ:', playersArea ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        if (playersArea) {
            console.log('ğŸ‘¥ ç©å®¶æ˜¾ç¤ºåŒºåŸŸHTML:', playersArea.innerHTML);
            
            // æ‰‹åŠ¨æµ‹è¯•æ˜¾ç¤ºæœºå™¨äºº
            setTimeout(() => {
                console.log('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•æ˜¾ç¤ºæœºå™¨äºº...');
                const testPlayers = [
                    { id: 'test1', nickname: 'hyq', chips: 1000, is_bot: false, status: 'waiting' },
                    { id: 'test2', nickname: 'ğŸ¤– æ–°æ‰‹1', chips: 1000, is_bot: true, status: 'waiting' },
                    { id: 'test3', nickname: 'ğŸ¤– è€å¸æœº2', chips: 1000, is_bot: true, status: 'waiting' }
                ];
                
                displayPlayers(testPlayers);
            }, 2000);
        }

        // æ£€æŸ¥æ˜¯å¦ test è´¦å·ï¼Œæ˜¾ç¤ºèƒœç‡è®¡ç®—å™¨æŒ‰é’®
        if (currentPlayer && currentPlayer.nickname === 'test') {
            const btn = document.createElement('button');
            btn.id = 'winProbBtn';
            btn.textContent = 'èƒœç‡è®¡ç®—å™¨';
            btn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg ml-2';
            btn.onclick = function() {
                btn.disabled = true;
                btn.textContent = 'è®¡ç®—ä¸­...';
                fetch('/api/win_probability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_id: tableId, player_id: myPlayerId })
                })
                .then(r => r.json())
                .then(res => {
                    btn.disabled = false;
                    btn.textContent = 'èƒœç‡è®¡ç®—å™¨';
                    if (res.success && res.data) {
                        alert(`èƒœç‡: ${(res.data.win * 100).toFixed(1)}%\nå¹³å±€: ${(res.data.tie * 100).toFixed(1)}%\nå¤±è´¥: ${(res.data.lose * 100).toFixed(1)}%`);
                    } else {
                        alert(res.message || 'æ— æ³•è®¡ç®—èƒœç‡');
                    }
                })
                .catch(() => {
                    btn.disabled = false;
                    btn.textContent = 'èƒœç‡è®¡ç®—å™¨';
                    alert('ç½‘ç»œé”™è¯¯');
                });
            };
            // å‡è®¾æœ‰æ“ä½œåŒºdiv idä¸ºtableActionsï¼Œå¦åˆ™æ’å…¥body
            const actions = document.getElementById('tableActions') || document.body;
            actions.appendChild(btn);
        }

        // æ£€æŸ¥æ˜¯å¦ test è´¦å·ï¼Œæ˜¾ç¤ºè®°ç‰ŒåŠ©æ‰‹æŒ‰é’®
        if (currentPlayer && currentPlayer.nickname === 'test') {
            const btnHelper = document.createElement('button');
            btnHelper.id = 'cardHelperBtn';
            btnHelper.textContent = 'è®°ç‰ŒåŠ©æ‰‹';
            btnHelper.className = 'bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg ml-2';
            btnHelper.onclick = function() {
                btnHelper.disabled = true;
                btnHelper.textContent = 'åŠ è½½ä¸­...';
                fetch('/api/card_tracking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_id: tableId, player_id: myPlayerId })
                })
                .then(r => r.json())
                .then(res => {
                    btnHelper.disabled = false;
                    btnHelper.textContent = 'è®°ç‰ŒåŠ©æ‰‹';
                    if (res.success && res.data) {
                        const known = res.data.known_cards.map(c => `${c.rank}${c.suit}`).join(' ');
                        const remain = res.data.remaining_cards;
                        let remainStr = '';
                        if (remain) {
                            remainStr = `\nå‰©ä½™ç‰Œæ•°: ${remain.total_remaining}\nèŠ±è‰²: ${Object.entries(remain.suits).map(([s, n]) => `${s}:${n}`).join(' ')}\nç‚¹æ•°: ${Object.entries(remain.ranks).map(([r, n]) => `${r}:${n}`).join(' ')}`;
                        }
                        alert(`å·²çŸ¥ç‰Œ: ${known || 'æ— '}${remainStr}`);
                    } else {
                        alert(res.message || 'æ— æ³•è·å–è®°ç‰Œä¿¡æ¯');
                    }
                })
                .catch(() => {
                    btnHelper.disabled = false;
                    btnHelper.textContent = 'è®°ç‰ŒåŠ©æ‰‹';
                    alert('ç½‘ç»œé”™è¯¯');
                });
            };
            const actions = document.getElementById('tableActions') || document.body;
            actions.appendChild(btnHelper);
        }
    });

    function initEventListeners() {
        // æŒ‰é’®äº‹ä»¶
        document.getElementById('startHandBtn').addEventListener('click', startHand);
        document.getElementById('addBotBtn').addEventListener('click', addBot);
        document.getElementById('leaveTableBtn').addEventListener('click', leaveTable);
        
        // æ¸¸æˆåŠ¨ä½œæŒ‰é’®
        document.getElementById('foldBtn').addEventListener('click', () => playerAction('fold'));
        document.getElementById('checkBtn').addEventListener('click', () => playerAction('check'));
        document.getElementById('callBtn').addEventListener('click', () => playerAction('call'));
        document.getElementById('betBtn').addEventListener('click', showBetInput);
        document.getElementById('raiseBtn').addEventListener('click', showRaiseInput);
        document.getElementById('allinBtn').addEventListener('click', () => playerAction('all_in'));
        
        // ä¸‹æ³¨ç›¸å…³
        document.getElementById('confirmBetBtn').addEventListener('click', confirmBet);
        document.getElementById('cancelBetBtn').addEventListener('click', hideBetInput);
        
        // ä¸‹ä¸€è½®æŠ•ç¥¨
        document.getElementById('voteNextRoundBtn').addEventListener('click', voteNextRound);
        
        // åˆ·æ–°çŠ¶æ€æŒ‰é’®
        document.getElementById('refreshStateBtn').addEventListener('click', refreshGameState);
        
        // æŸ¥çœ‹å†å²è®°å½•æŒ‰é’®
        document.getElementById('viewHistoryBtn').addEventListener('click', viewPlayerHistory);

        // Socketäº‹ä»¶ç›‘å¬
        socket.on('table_joined', handleTableJoined);
        socket.on('hand_started', handleHandStarted);
        socket.on('your_cards', handleYourCards);
        socket.on('your_turn', handleYourTurn);
        socket.on('action_processed', handleActionProcessed);
        socket.on('table_updated', handleTableUpdated);
        socket.on('player_joined', handlePlayerJoined);
        socket.on('bot_added', handleBotAdded);
        socket.on('player_left', handlePlayerLeft);
        socket.on('hand_complete', handleHandComplete);
        socket.on('hand_ended', handleHandEnded);
        socket.on('new_hand_started', handleNewHandStarted);
        socket.on('waiting_for_players', handleWaitingForPlayers);
        
        // è°ƒè¯•ï¼šç›‘å¬æ‰€æœ‰Socket.IOäº‹ä»¶
        const originalEmit = socket.emit;
        socket.emit = function(event, ...args) {
            console.log('ğŸ”º å‘é€äº‹ä»¶:', event, args);
            return originalEmit.apply(this, [event, ...args]);
        };
        
        // ç›‘å¬æ‰€æœ‰æ¥æ”¶åˆ°çš„äº‹ä»¶
        socket.onAny((eventName, ...args) => {
            console.log('ğŸ”» æ¥æ”¶äº‹ä»¶:', eventName, args);
        });
        
        // ä¸‹ä¸€è½®æŠ•ç¥¨ç›¸å…³äº‹ä»¶
        socket.on('show_next_round_vote', handleShowNextRoundVote);
        socket.on('next_round_vote_update', handleNextRoundVoteUpdate);
        socket.on('new_hand_started', handleNewHandStarted);
        
        // æœºå™¨äººæ€è€ƒäº‹ä»¶
        socket.on('bot_thinking', handleBotThinking);
    }

    function connectToTable() {
        // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´çš„ç©å®¶ä¿¡æ¯
        if (!myPlayerId || !currentPlayer || !currentPlayer.nickname) {
            showNotification('ç¼ºå°‘ç©å®¶ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            setTimeout(() => location.href = '/', 2000);
            return;
        }
        
        console.log('ğŸ”— å¼€å§‹è¿æ¥åˆ°ç‰Œæ¡Œ...', { tableId, myPlayerId, nickname: currentPlayer.nickname });
        
        // ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
        socket.on('connect', function() {
            console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
            registerAndJoinTable();
        });
        
        // ç›‘å¬è¿æ¥æ–­å¼€äº‹ä»¶
        socket.on('disconnect', function(reason) {
            console.log('ğŸ”Œ WebSocketè¿æ¥æ–­å¼€:', reason);
            showNotification('è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...', 'warning');
        });
        
        // ç›‘å¬é‡è¿äº‹ä»¶
        socket.on('reconnect', function(attemptNumber) {
            console.log('ğŸ”„ WebSocketé‡è¿æˆåŠŸï¼Œå°è¯•æ¬¡æ•°:', attemptNumber);
            showNotification('é‡è¿æˆåŠŸï¼', 'success');
            registerAndJoinTable();
        });
        
        // ç›‘å¬é‡è¿å°è¯•
        socket.on('reconnect_attempt', function(attemptNumber) {
            console.log('ğŸ”„ æ­£åœ¨å°è¯•é‡è¿...', attemptNumber);
        });
        
        // ç›‘å¬é‡è¿å¤±è´¥
        socket.on('reconnect_failed', function() {
            console.log('âŒ é‡è¿å¤±è´¥');
            showNotification('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
        });
        
        // å¦‚æœå·²ç»è¿æ¥ï¼Œç›´æ¥æ³¨å†Œ
        if (socket.connected) {
            console.log('âœ… WebSocketå·²è¿æ¥ï¼Œç›´æ¥æ³¨å†Œ');
            registerAndJoinTable();
        } else {
            console.log('â³ Socketæœªè¿æ¥ï¼Œç­‰å¾…è¿æ¥...');
        }
        
        // ç›‘å¬é”™è¯¯
        socket.on('error', function(data) {
            console.error('âŒ è¿æ¥é”™è¯¯:', data);
            showNotification(data.message || 'è¿æ¥é”™è¯¯', 'error');
        });

        // ç›‘å¬ç©å®¶ä¸å­˜åœ¨é”™è¯¯
        socket.on('player_not_found', function(data) {
            showNotification(data.message || 'ç©å®¶ä¸å­˜åœ¨', 'error');
            showNotification('æ­£åœ¨é‡å®šå‘åˆ°ä¸»é¡µ...', 'info');
            setTimeout(() => {
                location.href = '/';
            }, 2000);
        });
    }
    
    function registerAndJoinTable() {
        console.log('ğŸ“ æ³¨å†Œç©å®¶ä¼šè¯...');
        
        // å…ˆæ³¨å†Œç©å®¶ä¼šè¯ï¼Œå‘é€å®Œæ•´çš„ç©å®¶ä¿¡æ¯
        socket.emit('register_player', { 
            player_id: myPlayerId,
            nickname: currentPlayer.nickname
        });
        
        // ç›‘å¬æ³¨å†Œç»“æœ
        socket.on('player_registered', function(data) {
            console.log('ğŸ“ ç©å®¶æ³¨å†Œç»“æœ:', data);
            if (data.success) {
                console.log('ğŸšª åŠ å…¥ç‰Œæ¡Œæˆ¿é—´...');
                // æ³¨å†ŒæˆåŠŸååŠ å…¥ç‰Œæ¡Œæˆ¿é—´
                socket.emit('join_table', { table_id: tableId });
                
                // æ·»åŠ è¶…æ—¶æ£€æŸ¥ï¼Œå¦‚æœ3ç§’å†…æ²¡æœ‰æ”¶åˆ°table_joinedäº‹ä»¶ï¼Œå°±æ‰‹åŠ¨è¯·æ±‚ç‰Œæ¡ŒçŠ¶æ€
                setTimeout(() => {
                    if (!currentTableState) {
                        console.log('âš ï¸  3ç§’å†…æœªæ”¶åˆ°table_joinedäº‹ä»¶ï¼Œæ‰‹åŠ¨è¯·æ±‚ç‰Œæ¡ŒçŠ¶æ€');
                        socket.emit('get_table_state', { table_id: tableId });
                    }
                }, 3000);
            } else {
                showNotification('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥', 'error');
                setTimeout(() => location.href = '/lobby', 2000);
            }
        });
        
        // æ·»åŠ è¶…æ—¶å¤„ç†
        setTimeout(() => {
            if (!currentTableState) {
                console.log('â° è¿æ¥è¶…æ—¶ï¼Œå°è¯•é‡æ–°åŠ å…¥...');
                socket.emit('join_table', { table_id: tableId });
            }
        }, 3000);
    }

    function startHand() {
        socket.emit('start_hand');
    }

    function addBot() {
        // åˆ›å»ºä¸€ä¸ªç®€å•çš„é€‰æ‹©èœå•
        const botLevels = [
            { value: 'beginner', name: 'åˆçº§æœºå™¨äºº', desc: 'éšæœºç­–ç•¥ï¼Œé€‚åˆæ–°æ‰‹ç»ƒä¹ ' },
            { value: 'intermediate', name: 'ä¸­çº§æœºå™¨äºº', desc: 'è’™ç‰¹å¡æ´›ç­–ç•¥ï¼Œæœ‰ä¸€å®šæŠ€å·§' },
            { value: 'advanced', name: 'é«˜çº§æœºå™¨äºº', desc: 'å¤æ‚ç­–ç•¥ï¼Œä¼šè¯ˆå”¬å’Œåˆ†æ' },
            { value: 'god', name: 'å¾·å·æ‰‘å…‹ä¹‹ç¥', desc: 'ğŸ”® èƒ½çœ‹åˆ°æ‰€æœ‰æ‰‹ç‰Œçš„ä½œå¼ŠAIï¼Œç»å¯¹å¼ºå¤§' }
        ];
        
        let optionText = 'é€‰æ‹©æœºå™¨äººç­‰çº§ï¼š\n\n';
        botLevels.forEach((bot, index) => {
            optionText += `${index + 1}. ${bot.name} - ${bot.desc}\n`;
        });
        optionText += '\nè¾“å…¥æ•°å­— 1-4 é€‰æ‹©æœºå™¨äººç­‰çº§ï¼š';
        
        const choice = prompt(optionText);
        const choiceNum = parseInt(choice);
        
        if (choiceNum >= 1 && choiceNum <= 4) {
            const selectedLevel = botLevels[choiceNum - 1].value;
            socket.emit('add_bot', { level: selectedLevel });
        }
    }

    function leaveTable() {
        if (confirm('ç¡®å®šè¦ç¦»å¼€ç‰Œæ¡Œå—ï¼Ÿ')) {
            socket.emit('leave_table');
            location.href = '/lobby';
        }
    }

    function playerAction(action, amount = 0) {
        console.log('æ‰§è¡Œç©å®¶åŠ¨ä½œ:', { action, amount, playerId: myPlayerId });
        socket.emit('player_action', {
            action: action,
            amount: amount
        });
        hideActionButtons();
    }

    function showBetInput() {
        document.getElementById('betInputArea').classList.remove('hidden');
        document.getElementById('betAmount').focus();
        document.getElementById('betAmount').placeholder = 'è¾“å…¥ä¸‹æ³¨é‡‘é¢';
    }

    function showRaiseInput() {
        document.getElementById('betInputArea').classList.remove('hidden');
        document.getElementById('betAmount').focus();
        document.getElementById('betAmount').placeholder = 'è¾“å…¥åŠ æ³¨é‡‘é¢';
        // è®¾ç½®æœ€å°åŠ æ³¨é¢
        if (currentTableState) {
            const myPlayer = currentTableState.players.find(p => p.id === myPlayerId);
            const minRaise = currentTableState.current_bet + currentTableState.big_blind;
            document.getElementById('betAmount').min = minRaise;
            document.getElementById('betAmount').placeholder = `æœ€å°åŠ æ³¨: $${minRaise}`;
        }
    }

    function hideBetInput() {
        document.getElementById('betInputArea').classList.add('hidden');
        document.getElementById('betAmount').value = '';
    }

    function confirmBet() {
        const amount = parseInt(document.getElementById('betAmount').value);
        if (amount && amount > 0) {
            // ç®€åŒ–é€»è¾‘ï¼šæ ¹æ®å½“å‰æŠ•æ³¨æƒ…å†µå†³å®šæ˜¯ä¸‹æ³¨è¿˜æ˜¯åŠ æ³¨
            if (currentTableState && currentTableState.current_bet > 0) {
                // å¦‚æœå·²æœ‰ä¸‹æ³¨ï¼Œåˆ™è¿›è¡ŒåŠ æ³¨
                playerAction('raise', amount);
            } else {
                // å¦‚æœæ²¡æœ‰ä¸‹æ³¨ï¼Œåˆ™è¿›è¡Œä¸‹æ³¨
                playerAction('bet', amount);
            }
            hideBetInput();
        }
    }

    function hideActionButtons() {
        document.getElementById('actionButtons').classList.add('hidden');
    }

    function showActionButtons(canCheck, callAmount) {
        const actionButtons = document.getElementById('actionButtons');
        const checkBtn = document.getElementById('checkBtn');
        const callBtn = document.getElementById('callBtn');
        const betBtn = document.getElementById('betBtn');
        const raiseBtn = document.getElementById('raiseBtn');
        const allinBtn = document.getElementById('allinBtn');
        const foldBtn = document.getElementById('foldBtn');
        const callAmountSpan = document.getElementById('callAmount');

        actionButtons.classList.remove('hidden');

        // åŸºæœ¬æ“ä½œï¼šå¼ƒç‰Œå’Œå…¨ä¸‹æ€»æ˜¯å¯ç”¨
        foldBtn.classList.remove('hidden');
        allinBtn.classList.remove('hidden');

        if (canCheck) {
            // å¯ä»¥è¿‡ç‰Œæ—¶ï¼Œæ˜¾ç¤ºè¿‡ç‰Œå’Œä¸‹æ³¨
            checkBtn.classList.remove('hidden');
            callBtn.classList.add('hidden');
            betBtn.classList.remove('hidden');
            raiseBtn.classList.add('hidden');
        } else {
            // éœ€è¦è·Ÿæ³¨æ—¶ï¼Œæ˜¾ç¤ºè·Ÿæ³¨å’ŒåŠ æ³¨
            checkBtn.classList.add('hidden');
            callBtn.classList.remove('hidden');
            callAmountSpan.textContent = callAmount;
            betBtn.classList.add('hidden');
            raiseBtn.classList.remove('hidden');
        }
    }

    // Socketäº‹ä»¶å¤„ç†å‡½æ•°
    function handleTableJoined(data) {
        console.log('ğŸšª æ”¶åˆ°table_joinedäº‹ä»¶:', data);
        if (data.success) {
            currentTableState = data.table;
            
            // è°ƒè¯•ï¼šæ£€æŸ¥ç©å®¶æ•°æ®
            if (currentTableState && currentTableState.players) {
                console.log('ğŸ“Š ç‰Œæ¡Œç©å®¶æ•°æ®:', currentTableState.players);
                const botCount = currentTableState.players.filter(p => p.is_bot).length;
                const humanCount = currentTableState.players.filter(p => !p.is_bot).length;
                console.log(`ğŸ¤– æœºå™¨äººæ•°é‡: ${botCount}, ğŸ‘¤ äººç±»ç©å®¶: ${humanCount}`);
            }
            
            // åŒæ­¥ç©å®¶IDï¼ˆç‰¹åˆ«é‡è¦åœ¨é‡è¿æ—¶ï¼‰
            const synced = syncPlayerIdWithBackend(data.table);
            
            updateTableDisplay();
            
            if (data.reconnected) {
                showNotification('ğŸ”— é‡æ–°è¿æ¥æˆåŠŸï¼', 'success');
                // é‡è¿åç«‹å³æ£€æŸ¥æ˜¯å¦è½®åˆ°æˆ‘è¡ŒåŠ¨
                setTimeout(() => checkIfMyTurn(), synced ? 600 : 500);
            } else {
                showNotification('æˆåŠŸåŠ å…¥ç‰Œæ¡Œï¼', 'success');
                if (synced) {
                    setTimeout(() => checkIfMyTurn(), 100);
                } else {
                    checkIfMyTurn();
                }
            }
        }
    }

    function handleHandStarted(data) {
        console.log('æ¸¸æˆå¼€å§‹äº‹ä»¶:', data);
        currentTableState = data.table;
        
        // ğŸµ éŸ³ä¹é›†æˆï¼šæ‰‹ç‰Œå¼€å§‹æ—¶åˆ‡æ¢åˆ°æ¸¸æˆæ¡ŒéŸ³ä¹
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('table');
        }
        
        // æ¸…ç©ºæˆ‘çš„æ‰‹ç‰Œæ˜¾ç¤º
        document.getElementById('myCards').innerHTML = '';
        
        // æ¸…ç©ºæ“ä½œè®°å½•
        clearActionLog();
        addActionLog('ç³»ç»Ÿ', 'game_start', 0, `ğŸ® ç¬¬${data.table.hand_number}æ‰‹å¼€å§‹`);
        
        // åŒæ­¥ç©å®¶ID
        const synced = syncPlayerIdWithBackend(data.table);
        
        updateTableDisplay();
        showNotification('ğŸ® æ–°æ‰‹ç‰Œå¼€å§‹ï¼ç­‰å¾…å‘ç‰Œ...', 'info');
        
        // éšè—æ“ä½œæŒ‰é’®ï¼Œç­‰å¾…æ‰‹ç‰Œ
        hideActionButtons();
        
        // æ£€æŸ¥æ˜¯å¦è½®åˆ°æˆ‘è¡ŒåŠ¨
        setTimeout(() => checkIfMyTurn(), synced ? 600 : 500);
    }

    function handleYourCards(data) {
        console.log('æ”¶åˆ°æ‰‹ç‰Œ:', data.hole_cards);
        console.log('æ‰‹ç‰Œè¯¦ç»†ä¿¡æ¯:', JSON.stringify(data.hole_cards, null, 2));
        displayMyCards(data.hole_cards);
        showNotification('ğŸ“‹ æ‰‹ç‰Œå·²å‘æ”¾ï¼', 'success');
    }

    function handleYourTurn(data) {
        console.log('è½®åˆ°ä½ äº†:', data);
        
        // ğŸµ éŸ³ä¹é›†æˆï¼šè½®åˆ°æˆ‘è¡ŒåŠ¨æ—¶æ’­æ”¾ç´§å¼ éŸ³ä¹
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('action');
        }
        
        // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰ç­¹ç 
        const myPlayer = currentTableState ? currentTableState.players.find(p => p.id === myPlayerId) : null;
        if (!myPlayer || myPlayer.chips <= 0 || myPlayer.status === 'broke') {
            console.log('ç©å®¶æ²¡æœ‰ç­¹ç ï¼Œæˆä¸ºè§‚å¯Ÿè€…ï¼Œä¸æ˜¾ç¤ºæ“ä½œæŒ‰é’®');
            showNotification('ğŸ’¸ æ‚¨æ²¡æœ‰ç­¹ç äº†ï¼Œåªèƒ½è§‚å¯Ÿæ¸¸æˆ', 'info', 3000);
            hideActionButtons();
            return;
        }
        
        const canCheck = data.current_bet === 0 || data.current_bet <= (data.your_bet || 0);
        const callAmount = Math.max(0, data.current_bet - (data.your_bet || 0));
        
        showActionButtons(canCheck, callAmount);
        showNotification('è½®åˆ°æ‚¨è¡ŒåŠ¨äº†', 'info', 2000);
        addActionLog('ç³»ç»Ÿ', 'your_turn', 0, 'è½®åˆ°æ‚¨è¡ŒåŠ¨');
    }

    function handleActionProcessed(data) {
        currentTableState = data.table;
        
        // ğŸµ éŸ³ä¹é›†æˆï¼šæ ¹æ®åŠ¨ä½œç±»å‹æ’­æ”¾éŸ³æ•ˆ
        if (window.musicPlayer && data.action) {
            // å¦‚æœæ˜¯æˆ‘çš„åŠ¨ä½œå®Œæˆï¼Œåˆ‡æ¢å›å¹³é™éŸ³ä¹
            if (data.player_id === myPlayerId) {
                musicPlayer.switchToTrack('table');
            }
            // å¦‚æœæœ‰å¤§é¢ä¸‹æ³¨æˆ–å…¨ä¸‹ï¼Œæ’­æ”¾ç´§å¼ éŸ³ä¹
            else if ((data.action === 'bet' || data.action === 'raise') && data.amount >= 100) {
                musicPlayer.switchToTrack('action');
            }
            else if (data.action === 'allin') {
                musicPlayer.switchToTrack('action');
            }
        }
        
        // è®°å½•æ“ä½œ
        if (data.action && data.player_id) {
            const player = data.table.players.find(p => p.id === data.player_id);
            const playerName = player ? player.nickname : 'æœªçŸ¥ç©å®¶';
            addActionLog(playerName, data.action, data.amount || 0, data.description);
        }
        
        // åŒæ­¥ç©å®¶ID
        const synced = syncPlayerIdWithBackend(data.table);
        
        updateTableDisplay();
        
        // å¦‚æœè½®åˆ°æˆ‘è¡ŒåŠ¨ï¼Œæ˜¾ç¤ºæ“ä½œæŒ‰é’®
        if (synced) {
            setTimeout(() => checkIfMyTurn(), 100);
        } else {
            checkIfMyTurn();
        }
    }

    function handleTableUpdated(data) {
        currentTableState = data;
        
        // å¼ºåˆ¶åŒæ­¥ç©å®¶ID - æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        const synced = syncPlayerIdWithBackend(data);
        
        updateTableDisplay();
        
        // å¦‚æœè¿›è¡Œäº†IDåŒæ­¥ï¼Œå»¶è¿Ÿä¸€ä¸‹å†æ£€æŸ¥è½®æ¬¡ï¼Œç¡®ä¿åŒæ­¥ç”Ÿæ•ˆ
        if (synced) {
            setTimeout(() => checkIfMyTurn(), 100);
        } else {
            checkIfMyTurn();
        }
    }

    function handlePlayerJoined(data) {
        currentTableState = data.table;
        updateTableDisplay();
        
        // å¦‚æœæ˜¯æœºå™¨äººåŠ å…¥ï¼Œæ˜¾ç¤ºé€šçŸ¥
        if (data.player && data.player.is_bot) {
            showNotification(`ğŸ¤– æœºå™¨äºº ${data.player.nickname} å·²åŠ å…¥ç‰Œæ¡Œ`, 'success');
            
            // å¦‚æœç°åœ¨æœ‰2ä¸ªæˆ–æ›´å¤šç©å®¶ï¼Œæç¤ºå¯ä»¥å¼€å§‹æ¸¸æˆ
            if (currentTableState.can_start) {
                showNotification('ğŸ® ç°åœ¨å¯ä»¥å¼€å§‹æ¸¸æˆäº†ï¼', 'success');
            }
        }
    }

    function handleBotAdded(data) {
        if (data.success) {
            // æ›´æ–°ç‰Œæ¡ŒçŠ¶æ€ - éœ€è¦é‡æ–°è·å–å®Œæ•´çŠ¶æ€
            if (data.table) {
                currentTableState = data.table;
            }
            updateTableDisplay();
            showNotification(`ğŸ¤– æœºå™¨äºº ${data.bot.nickname} å·²åŠ å…¥ç‰Œæ¡Œ`, 'success');
            
            // å¦‚æœç°åœ¨å¯ä»¥å¼€å§‹æ¸¸æˆï¼Œæ˜¾ç¤ºæç¤º
            if (currentTableState && currentTableState.players && currentTableState.players.length >= 2) {
                showNotification('ğŸ® ç°åœ¨å¯ä»¥å¼€å§‹æ¸¸æˆäº†ï¼ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"æŒ‰é’®', 'info');
            }
        } else {
            showNotification('æ·»åŠ æœºå™¨äººå¤±è´¥', 'error');
        }
    }

    function handlePlayerLeft(data) {
        console.log('ç©å®¶ç¦»å¼€:', data);
        showNotification(`ğŸ‘‹ ${data.nickname} ç¦»å¼€äº†ç‰Œæ¡Œ`, 'info');
        
        // é‡æ–°è·å–ç‰Œæ¡ŒçŠ¶æ€
        // è¿™é‡Œæˆ‘ä»¬éœ€è¦è§¦å‘ä¸€ä¸ªçŠ¶æ€æ›´æ–°
        setTimeout(() => {
            // ç®€å•çš„æ–¹å¼ï¼šé‡æ–°åŠ è½½é¡µé¢
            location.reload();
        }, 1000);
    }

    function handleHandComplete(data) {
        console.log('æ¸¸æˆç»“æŸ:', data);
        
        // æ˜¾ç¤ºè·èƒœè€…ä¿¡æ¯
        if (data.winner) {
            showNotification(`ğŸ‰ ${data.winner.nickname} è·èƒœï¼èµ¢å¾— $${data.final_pot}`, 'success', 5000);
            addActionLog('ç³»ç»Ÿ', 'hand_end', data.final_pot, `ğŸ‰ ${data.winner.nickname} è·èƒœï¼Œèµ¢å¾— $${data.final_pot}`);
        }
        
        // éšè—æ“ä½œæŒ‰é’®
        hideActionButtons();
        
        // æ˜¾ç¤ºå€’è®¡æ—¶ä¿¡æ¯
        showNotification('â° 1ç§’åè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€å±€...', 'info', 2000);
    }

    function handleHandEnded(data) {
        console.log('ğŸ† æ‰‹ç‰Œç»“æŸ:', data);
        
        // ğŸµ éŸ³ä¹é›†æˆï¼šæ‰‹ç‰Œç»“æŸæ—¶åˆ‡æ¢å›å¹³é™çš„æ¸¸æˆæ¡ŒéŸ³ä¹
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('table');
        }
        
        // è°ƒè¯•ï¼šæ£€æŸ¥æ‘Šç‰Œæ•°æ®
        console.log('ğŸƒ æ‘Šç‰Œæ•°æ®æ£€æŸ¥:');
        console.log('  - showdown_infoå­˜åœ¨:', !!data.showdown_info);
        console.log('  - is_showdown:', data.showdown_info?.is_showdown);
        console.log('  - showdown_playersæ•°é‡:', data.showdown_info?.showdown_players?.length || 0);
        if (data.showdown_info?.showdown_players) {
            data.showdown_info.showdown_players.forEach((player, i) => {
                console.log(`  - ç©å®¶${i+1}: ${player.nickname} - ${player.hand_description}`);
            });
        }
        
        // æ›´æ–°æ¡Œé¢çŠ¶æ€ï¼ˆåŒ…å«æ›´æ–°åçš„ç­¹ç ï¼‰
        if (data.table_state) {
            console.log('ğŸ“Š æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ŒåŒ…å«æœ€æ–°ç­¹ç ä¿¡æ¯');
            currentTableState = data.table_state;
            updateTableDisplay();
        }
        
        // æ˜¾ç¤ºè·èƒœè€…ä¿¡æ¯
        if (data.winners && data.winners.length > 0) {
            const winner = data.winners[0];
            const pot = currentTableState ? currentTableState.pot : 0;
            showNotification(`ğŸ‰ ${winner.nickname} è·èƒœï¼èµ¢å¾— $${pot}`, 'success', 5000);
            addActionLog('ç³»ç»Ÿ', 'hand_end', pot, `ğŸ‰ ${winner.nickname} è·èƒœï¼Œèµ¢å¾— $${pot}`);
            
            // å¦‚æœæˆ‘æ˜¯è·èƒœè€…ï¼Œç‰¹åˆ«æç¤ºç­¹ç å¢åŠ 
            if (winner.nickname === currentPlayer.nickname) {
                const myPlayer = currentTableState.players.find(p => p.id === myPlayerId);
                if (myPlayer) {
                    showNotification(`ğŸ’° æ­å–œï¼æ‚¨ç°åœ¨æœ‰ $${myPlayer.chips} ç­¹ç `, 'success', 3000);
                }
            }
        }
        
        // æ‘Šç‰Œä¿¡æ¯æ˜¾ç¤ºé€»è¾‘ä¼˜åŒ– - æ”¾å®½æ˜¾ç¤ºæ¡ä»¶
        console.log('ğŸƒ æ‘Šç‰Œæ•°æ®å®Œæ•´æ£€æŸ¥:');
        console.log('  - showdown_infoå­˜åœ¨:', !!data.showdown_info);
        console.log('  - is_showdown:', data.showdown_info?.is_showdown);
        console.log('  - showdown_playersæ•°é‡:', data.showdown_info?.showdown_players?.length || 0);
        console.log('  - winnersæ•°é‡:', data.winners?.length || 0);
        
        // ä¼˜åŒ–åçš„æ˜¾ç¤ºæ¡ä»¶ï¼šä¼˜å…ˆæ˜¾ç¤ºæ‘Šç‰Œè¯¦æƒ…ï¼ŒåŒ…æ‹¬å•äººè·èƒœçš„æƒ…å†µ
        if (data.showdown_info && data.showdown_info.showdown_players && data.showdown_info.showdown_players.length > 0) {
            console.log('âœ… æ˜¾ç¤ºå®Œæ•´æ‘Šç‰Œè¯¦æƒ…ï¼ˆåŒ…æ‹¬å•äººè·èƒœï¼‰');
            showShowdownDetails(data.showdown_info);
        } else if (data.showdown_info && data.showdown_info.community_cards && data.showdown_info.community_cards.length > 0) {
            console.log('âœ… æ˜¾ç¤ºåŸºç¡€æ‘Šç‰Œä¿¡æ¯');
            showShowdownDetails(data.showdown_info);
        } else if (data.winners && data.winners.length > 0) {
            console.log('âœ… æ˜¾ç¤ºè·èƒœè€…ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¼ƒç‰Œè·èƒœï¼‰');
            showSimpleWinnerInfo(data.winners);
        } else {
            console.log('âŒ æ²¡æœ‰å¯æ˜¾ç¤ºçš„è·èƒœä¿¡æ¯');
            // å³ä½¿æ²¡æœ‰å…·ä½“è·èƒœè€…æ•°æ®ï¼Œä¹Ÿåº”è¯¥æ˜¾ç¤ºåŸºæœ¬çš„æ‰‹ç‰Œç»“æŸæç¤º
            if (data.message) {
                console.log('ğŸ“¢ æ˜¾ç¤ºæ‰‹ç‰Œç»“æŸæ¶ˆæ¯');
                showNotification(data.message, 'success', 5000);
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        if (data.message) {
            showNotification(data.message, 'info', 3000);
        }
        
        // éšè—æ“ä½œæŒ‰é’®
        hideActionButtons();
        
        // æ¸…ç©ºæˆ‘çš„æ‰‹ç‰Œæ˜¾ç¤º
        document.getElementById('myCards').innerHTML = '';
    }

    function showShowdownDetails(showdownInfo) {
        console.log('ğŸƒ æ˜¾ç¤ºæ‘Šç‰Œè¯¦æƒ…:', showdownInfo);
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå¼ƒç‰Œè·èƒœ
        const isFoldWin = showdownInfo.win_reason === 'others_folded';
        const title = isFoldWin ? 'ğŸ† è·èƒœç»“æœï¼ˆå…¶ä»–ç©å®¶å¼ƒç‰Œï¼‰' : 'ğŸƒ æ‘Šç‰Œç»“æœ';
        
        // åˆ›å»ºæ‘Šç‰Œè¯¦æƒ…å¼¹çª—
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">${title}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                ${isFoldWin ? '<div class="mb-4 p-3 bg-green-800 rounded-lg"><p class="text-green-200 text-center">ğŸ‰ æ‚¨é€šè¿‡åŠ æ³¨è®©æ‰€æœ‰å¯¹æ‰‹å¼ƒç‰Œè·èƒœï¼</p></div>' : ''}
                
                <!-- å…¬å…±ç‰Œæ˜¾ç¤º -->
                ${showdownInfo.community_cards && showdownInfo.community_cards.length > 0 ? `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-300 mb-2">ğŸ´ å…¬å…±ç‰Œ</h4>
                    <div class="flex gap-2">
                        ${showdownInfo.community_cards.map(card => {
                            const isRed = card.suit === 'â™¥' || card.suit === 'â™¦';
                            const textColor = isRed ? 'text-red-500' : 'text-black';
                            return `<div class="bg-white rounded-lg p-2 text-center min-w-[40px] shadow-md">
                                <div class="text-lg font-bold ${textColor}">
                                    <div class="text-sm">${card.rank}</div>
                                    <div class="text-lg">${card.suit}</div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>` : ''}
                
                <!-- ç©å®¶æ‘Šç‰Œè¯¦æƒ… -->
                ${showdownInfo.showdown_players && showdownInfo.showdown_players.length > 0 ? `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-300">ğŸ† ç©å®¶æ’å</h4>
                    ${showdownInfo.showdown_players.map((player, index) => {
                        const rankEmoji = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                        const playerType = player.is_bot ? 'ğŸ¤–' : 'ğŸ‘¤';
                        const resultColor = player.result === 'winner' ? 'text-green-400' : 'text-gray-400';
                        
                        return `
                            <div class="bg-gray-700 rounded-lg p-4 border ${player.result === 'winner' ? 'border-green-500' : 'border-gray-600'}">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">${rankEmoji}</span>
                                        <span class="text-lg font-semibold text-white">${playerType} ${player.nickname}</span>
                                        <span class="${resultColor} font-medium">
                                            ${player.result === 'winner' ? `èµ¢å¾— $${player.winnings}` : 'è´¥åŒ—'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-4">
                                    <!-- åº•ç‰Œ -->
                                    <div class="flex gap-1">
                                        ${player.hole_cards.map(card => {
                                            const isRed = card.suit === 'â™¥' || card.suit === 'â™¦';
                                            const textColor = isRed ? 'text-red-500' : 'text-black';
                                            return `<div class="bg-white rounded p-1 text-center min-w-[35px] text-sm shadow">
                                                <div class="font-bold ${textColor}">
                                                    <div class="text-xs">${card.rank}</div>
                                                    <div class="text-sm">${card.suit}</div>
                                                </div>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                    
                                    <!-- ç®­å¤´ -->
                                    <span class="text-gray-400">â†’</span>
                                    
                                    <!-- ç‰Œå‹ -->
                                    <div class="flex-1">
                                        <span class="text-yellow-400 font-semibold">${player.hand_description}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>` : ''}
                
                <div class="mt-6 text-center">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        ç¡®å®š
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // 3ç§’åæ˜¾ç¤ºå…³é—­æç¤º
        setTimeout(() => {
            const hint = document.createElement('div');
            hint.className = 'absolute top-2 right-2 bg-yellow-600 text-white px-2 py-1 rounded text-sm';
            hint.textContent = 'ç‚¹å‡»ç¡®å®šæˆ–èƒŒæ™¯å…³é—­';
            modal.querySelector('.bg-gray-800').appendChild(hint);
            
            setTimeout(() => hint.remove(), 2000);
        }, 3000);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function showSimpleWinnerInfo(winners) {
        console.log('ğŸ† æ˜¾ç¤ºç®€åŒ–è·èƒœè€…ä¿¡æ¯:', winners);
        
        // åˆ›å»ºç®€åŒ–è·èƒœè€…ä¿¡æ¯å¼¹çª—
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        
        let winnersHtml = '';
        winners.forEach((winner, index) => {
            winnersHtml += `
                <div class="mb-4 p-4 bg-green-800 rounded-lg">
                    <div class="text-lg font-bold text-green-200 mb-2">
                        ğŸ† è·èƒœè€…: ${winner.nickname}
                    </div>
                    <div class="text-green-300 mb-2">
                        è·å¾—å¥–é‡‘: $${winner.amount || 0}
                    </div>
                    ${winner.hole_cards && winner.hole_cards.length > 0 ? `
                        <div class="text-sm text-green-400 mb-2">è·èƒœæ‰‹ç‰Œ:</div>
                        <div class="flex space-x-2 justify-center mb-2">
                            ${winner.hole_cards.map(card => {
                                const isRed = card.suit === 'â™¥' || card.suit === 'â™¦';
                                const textColor = isRed ? 'text-red-500' : 'text-black';
                                return `<div class="bg-white rounded border border-gray-300 w-12 h-16 flex items-center justify-center text-xs font-bold ${textColor}">
                                    <div class="text-center">
                                        <div class="text-xs">${card.rank}</div>
                                        <div class="text-sm">${card.suit}</div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    ` : ''}
                    ${winner.hand_description ? `
                        <div class="text-yellow-300 text-sm font-semibold">
                            ${winner.hand_description}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border-2 border-green-500">
                <h3 class="text-xl font-bold text-white mb-4 text-center">ğŸ‰ æ‰‹ç‰Œç»“æŸ</h3>
                ${winnersHtml}
                <div class="text-center text-gray-400 text-sm mb-4">
                    ${winners.some(w => !w.hole_cards || w.hole_cards.length === 0) ? 
                        'ğŸƒ å…¶ä»–ç©å®¶å¼ƒç‰Œï¼Œæ— éœ€æ‘Šç‰Œ' : 
                        'ğŸƒ æ‘Šç‰Œç»“æœ'
                    }
                </div>
                <button onclick="this.closest('.fixed').remove()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mt-4">
                    ç¡®å®š
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function handleNewHandStarted(data) {
        console.log('æ–°ä¸€å±€å¼€å§‹:', data);
        showNotification(`ğŸ® ${data.message}`, 'success');
        
        // æ¸…ç©ºæˆ‘çš„æ‰‹ç‰Œæ˜¾ç¤º
        document.getElementById('myCards').innerHTML = '';
        
        // ç­‰å¾…æ›´æ–°çš„æ¸¸æˆçŠ¶æ€
        setTimeout(() => {
            updateTableDisplay();
            checkIfMyTurn();
        }, 500);
    }

    function handleWaitingForPlayers(data) {
        console.log('ç­‰å¾…ç©å®¶:', data);
        showNotification(`â³ ${data.message}`, 'warning');
        hideActionButtons();
    }

    function updateTableDisplay() {
        if (!currentTableState) return;

        // æ›´æ–°åŸºæœ¬ä¿¡æ¯
        document.getElementById('tableTitle').textContent = currentTableState.title;
        // æ›´æ–°æ¸¸æˆæ¨¡å¼å’Œç›²æ³¨ä¿¡æ¯
        const gameModeInfo = document.getElementById('gameModeInfo');
        const blindInfo = document.getElementById('blindInfo');
        
        if (currentTableState.game_mode === 'ante') {
            const antePercentage = (currentTableState.ante_percentage * 100).toFixed(1);
            gameModeInfo.innerHTML = `âš–ï¸ æŒ‰æ¯”ä¾‹: <span id="blindInfo">${antePercentage}%</span>`;
        } else {
            gameModeInfo.innerHTML = `ğŸ¯ ç›²æ³¨: <span id="blindInfo">${currentTableState.small_blind}/${currentTableState.big_blind}</span>`;
        }
        document.getElementById('potAmount').textContent = currentTableState.pot;
        document.getElementById('potDisplay').textContent = currentTableState.pot;
        document.getElementById('handNumber').textContent = currentTableState.hand_number;
        
        // æ˜¾ç¤ºå½“å‰è¡ŒåŠ¨ç©å®¶æç¤º
        let statusText = '';
        if (currentTableState.current_player_id) {
            const currentPlayer = currentTableState.players.find(p => p.id === currentTableState.current_player_id);
            if (currentPlayer) {
                if (currentPlayer.id === myPlayerId) {
                    statusText = ' | ğŸ”” è½®åˆ°æ‚¨è¡ŒåŠ¨';
                } else {
                    statusText = ` | â³ ç­‰å¾… ${currentPlayer.nickname} è¡ŒåŠ¨`;
                }
            }
        }
        document.getElementById('tableTitle').textContent = currentTableState.title + statusText;

        // æ›´æ–°å…¬å…±ç‰Œ
        displayCommunityCards(currentTableState.community_cards);
        
        // æ›´æ–°ç©å®¶ä¿¡æ¯
        displayPlayers(currentTableState.players);
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹æ¸¸æˆ
        if (currentTableState.can_start) {
            document.getElementById('startHandBtn').classList.remove('hidden');
        } else {
            document.getElementById('startHandBtn').classList.add('hidden');
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªç©å®¶ï¼Œæ˜¾ç¤ºæç¤º
            if (currentTableState.players && currentTableState.players.length === 1) {
                showNotification('ğŸ’¡ æç¤ºï¼šè¯·æ·»åŠ æœºå™¨äººæˆ–ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥åå¼€å§‹æ¸¸æˆ', 'info');
            }
        }
    }

    function displayCommunityCards(cards) {
        const container = document.getElementById('communityCards');
        container.innerHTML = '';
        
        for (let i = 0; i < 5; i++) {
            const cardDiv = document.createElement('div');
            if (i < cards.length) {
                cardDiv.appendChild(createCardElement(cards[i]));
            } else {
                cardDiv.appendChild(createCardElement(null, true));
            }
            container.appendChild(cardDiv);
        }
    }

    function displayPlayers(players) {
        console.log('ğŸ‘¥ displayPlayers è¢«è°ƒç”¨ï¼Œç©å®¶æ•°æ®:', players);
        const container = document.getElementById('playersArea');
        container.innerHTML = '';

        players.forEach(player => {
            console.log(`å¤„ç†ç©å®¶: ${player.nickname}, is_bot: ${player.is_bot}`);
            const playerDiv = document.createElement('div');
            
            // åˆ¤æ–­æ˜¯å¦æ˜¯æˆ‘ï¼šä¼˜å…ˆé€šè¿‡IDï¼Œå…¶æ¬¡é€šè¿‡æ˜µç§°
            const isMe = (player.id === myPlayerId) || 
                        (currentPlayer && player.nickname === currentPlayer.nickname);
            const statusClass = player.status === 'playing' ? 'text-green-400' : 'text-gray-400';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰è¡ŒåŠ¨çš„ç©å®¶
            const isCurrentPlayer = currentTableState && currentTableState.current_player_id === player.id;
            
            // åŸºç¡€æ ·å¼
            let bgClass = 'bg-gray-600';
            let borderClass = 'border-2 border-transparent';
            let extraClass = '';
            
            // é«˜äº®å½“å‰è¡ŒåŠ¨çš„ç©å®¶ - æ›´å¼ºçš„è§†è§‰æ•ˆæœ
            if (isCurrentPlayer && currentTableState.game_stage !== 'waiting') {
                if (player.is_bot) {
                    // æœºå™¨äººè½®æ¬¡ - æ©™è‰²çªå‡ºæ˜¾ç¤º
                    bgClass = 'bg-orange-600';
                    borderClass = 'border-4 border-orange-300 shadow-xl shadow-orange-500/60';
                    extraClass = 'animate-pulse transform scale-105';
                } else {
                    // äººç±»ç©å®¶è½®æ¬¡ - è“è‰²çªå‡ºæ˜¾ç¤º
                    bgClass = 'bg-blue-700';
                    borderClass = 'border-4 border-yellow-300 shadow-xl shadow-yellow-400/60';
                    extraClass = 'animate-pulse transform scale-105';
                }
            }
            
            // dealerç©å®¶ç‰¹æ®ŠèƒŒæ™¯ - æ›´æ˜æ˜¾çš„æ ‡è¯†
            if (player.is_dealer) {
                if (!isCurrentPlayer || currentTableState.game_stage === 'waiting') {
                    bgClass = 'bg-red-700';
                    borderClass = 'border-3 border-red-300 shadow-lg shadow-red-400/50';
                    extraClass = 'transform scale-102';
                }
            }
            
            playerDiv.className = `${bgClass} ${borderClass} ${extraClass} rounded-lg p-3 transition-all duration-300`;
            
            playerDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-semibold ${isMe ? 'text-yellow-400' : 'text-white'}">
                            ${player.is_bot ? 'ğŸ¤– ' : 'ğŸ‘¤ '}${player.nickname} ${isMe ? '(ä½ )' : ''}
                            ${player.is_dealer ? ' <span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">ğŸ›ï¸ DEALER</span>' : ''}
                            ${isCurrentPlayer && currentTableState.game_stage !== 'waiting' ? 
                                player.is_bot ? ' <span class="bg-orange-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-bounce">ğŸ¤– æœºå™¨äººè¡ŒåŠ¨ä¸­</span>' 
                                : ' <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-bounce">ğŸ¯ ä½ çš„å›åˆ</span>' 
                                : ''}
                        </div>
                        <div class="text-sm ${statusClass}">
                            ${getPlayerStatusDisplay(player)}${player.is_bot ? ' â€¢ <span class="text-cyan-400">æœºå™¨äºº</span>' : ''}
                            ${player.is_dealer ? '<span class="text-red-300 font-bold bg-red-800/30 px-2 py-1 rounded"> â€¢ åº„å®¶</span>' : ''}
                            ${player.is_small_blind ? '<span class="text-blue-300 bg-blue-800/30 px-1 py-0.5 rounded"> â€¢ å°ç›²</span>' : ''}
                            ${player.is_big_blind ? '<span class="text-orange-300 bg-orange-800/30 px-1 py-0.5 rounded"> â€¢ å¤§ç›²</span>' : ''}
                            ${isCurrentPlayer && currentTableState.game_stage !== 'waiting' ? 
                                player.is_bot ? '<span class="text-orange-200 font-bold bg-orange-600/50 px-2 py-1 rounded animate-pulse"> â€¢ ğŸ¤– æ­£åœ¨æ€è€ƒ</span>'
                                : '<span class="text-green-200 font-bold bg-green-600/50 px-2 py-1 rounded animate-pulse"> â€¢ âš¡ è½®åˆ°ä½ äº†</span>'
                                : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-white font-semibold">$${player.chips}</div>
                        ${player.current_bet > 0 ? `<div class="text-yellow-400 text-sm">ä¸‹æ³¨: $${player.current_bet}</div>` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(playerDiv);
        });
    }

    function displayMyCards(cards) {
        console.log('displayMyCards è°ƒç”¨ï¼Œå‚æ•°:', cards);
        const container = document.getElementById('myCards');
        container.innerHTML = '';
        
        if (cards && cards.length === 2) {
            console.log('æ­£åœ¨æ˜¾ç¤º2å¼ æ‰‹ç‰Œ...');
            cards.forEach((card, index) => {
                console.log(`åˆ›å»ºç¬¬${index + 1}å¼ ç‰Œ:`, card);
                const cardElement = createCardElement(card);
                console.log('åˆ›å»ºçš„ç‰Œå…ƒç´ :', cardElement);
                container.appendChild(cardElement);
            });
            console.log('æ‰‹ç‰Œæ˜¾ç¤ºå®Œæˆï¼Œå®¹å™¨å†…å®¹:', container.innerHTML);
        } else {
            console.log('æ‰‹ç‰Œæ•°æ®æ— æ•ˆ:', { cards, length: cards ? cards.length : 'null' });
        }
    }

    function getPlayerStatusDisplay(player) {
        let statusText = '';
        let statusClass = 'bg-gray-600';
        
        switch (player.status) {
            case 'waiting':
                statusText = 'ç­‰å¾…ä¸­';
                statusClass = 'bg-blue-600';
                break;
            case 'playing':
                statusText = 'æ¸¸æˆä¸­';
                statusClass = 'bg-green-600';
                break;
            case 'folded':
                statusText = 'å¼ƒç‰Œ';
                statusClass = 'bg-red-600';
                break;
            case 'all_in':
                statusText = 'å…¨ä¸‹';
                statusClass = 'bg-purple-600';
                break;
            case 'broke':
                statusText = 'è§‚å¯Ÿè€… (æ— ç­¹ç )';
                statusClass = 'bg-gray-500';
                break;
            case 'disconnected':
                statusText = 'æ–­çº¿';
                statusClass = 'bg-red-800';
                break;
            default:
                statusText = player.status;
        }
        
        return `<span class="${statusClass} text-white px-2 py-1 rounded text-xs">${statusText}</span>`;
    }

    function syncPlayerIdWithBackend(tableState) {
        if (!tableState || !tableState.players || !currentPlayer) {
            console.log('âš ï¸ syncPlayerIdWithBackend: ç¼ºå°‘å¿…è¦æ•°æ®', { tableState: !!tableState, players: !!tableState?.players, currentPlayer: !!currentPlayer });
            return;
        }
        
        console.log('ğŸ” æ£€æŸ¥ç©å®¶IDåŒæ­¥:', {
            myPlayerId: myPlayerId,
            nickname: currentPlayer.nickname,
                            allPlayers: tableState.players.map(p => ({ id: p.id, nickname: p.nickname, is_bot: p.is_bot }))
        });
        
        // å…ˆé€šè¿‡æ˜µç§°æ‰¾åˆ°æ­£ç¡®çš„ç©å®¶ï¼ˆå› ä¸ºæ˜µç§°æ˜¯å¯ä¿¡çš„ï¼‰
        const foundByNickname = tableState.players.find(p => 
            p.nickname === currentPlayer.nickname && !p.is_bot
        );
        
        if (foundByNickname) {
            // æ£€æŸ¥IDæ˜¯å¦åŒ¹é…
            if (foundByNickname.id !== myPlayerId) {
                console.log('ğŸ”„ IDä¸åŒ¹é…ï¼Œæ­£åœ¨åŒæ­¥:', {
                    æ—§ID: myPlayerId,
                    æ–°ID: foundByNickname.id,
                    æ˜µç§°: currentPlayer.nickname
                });
                
                // æ›´æ–°å‰ç«¯çš„ç©å®¶ID
                myPlayerId = foundByNickname.id;
                
                // æ›´æ–°localStorage
                localStorage.setItem('player_id', myPlayerId);
                currentPlayer.id = myPlayerId;
                localStorage.setItem('poker_player', JSON.stringify(currentPlayer));
                
                // é‡æ–°æ³¨å†Œä¼šè¯
                socket.emit('register_player', { player_id: myPlayerId });
                
                console.log('âœ… ç©å®¶IDå·²åŒæ­¥:', myPlayerId);
                return true; // è¡¨ç¤ºè¿›è¡Œäº†åŒæ­¥
            } else {
                console.log('âœ… ç©å®¶IDåŒ¹é…æ­£ç¡®');
                return false; // è¡¨ç¤ºæ— éœ€åŒæ­¥
            }
        } else {
            console.log('âŒ æ— æ³•é€šè¿‡æ˜µç§°æ‰¾åˆ°åŒ¹é…çš„ç©å®¶:', currentPlayer.nickname);
            console.log('æ‰€æœ‰éæœºå™¨äººç©å®¶:', tableState.players.filter(p => !p.is_bot).map(p => p.nickname));
            return false;
        }
    }

    function checkIfMyTurn() {
        // æ ¹æ®æ¸¸æˆçŠ¶æ€åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæ“ä½œæŒ‰é’®
        console.log('=== æ£€æŸ¥æˆ‘çš„è½®æ¬¡ ===');
        console.log('å½“å‰æ¸¸æˆçŠ¶æ€:', currentTableState ? currentTableState.game_stage : 'æ— çŠ¶æ€');
        console.log('æˆ‘çš„ç©å®¶ID:', myPlayerId);
        console.log('æˆ‘çš„æ˜µç§°:', currentPlayer ? currentPlayer.nickname : 'æ— æ˜µç§°');
        
        if (currentTableState && currentTableState.game_stage !== 'waiting') {
            // å¼ºåˆ¶é€šè¿‡æ˜µç§°æ‰¾åˆ°æ­£ç¡®çš„ç©å®¶ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°çš„IDï¼‰
            let myPlayer = null;
            if (currentPlayer && currentPlayer.nickname) {
                myPlayer = currentTableState.players.find(p => 
                    p.nickname === currentPlayer.nickname && !p.is_bot
                );
                
                if (myPlayer && myPlayer.id !== myPlayerId) {
                    console.log('âš ï¸ åœ¨checkIfMyTurnä¸­å‘ç°IDä¸åŒ¹é…ï¼Œç«‹å³æ›´æ–°');
                    console.log('æ—§ID:', myPlayerId, 'æ–°ID:', myPlayer.id);
                    myPlayerId = myPlayer.id;  // æ›´æ–°å…¨å±€å˜é‡
                    // åŒæ—¶æ›´æ–°localStorage
                    localStorage.setItem('player_id', myPlayerId);
                    const updatedPlayer = { ...currentPlayer, id: myPlayer.id };
                    localStorage.setItem('poker_player', JSON.stringify(updatedPlayer));
                    currentPlayer = updatedPlayer;
                }
            }
            
            // å¦‚æœé€šè¿‡æ˜µç§°æ²¡æ‰¾åˆ°ï¼Œå†å°è¯•é€šè¿‡IDæ‰¾
            if (!myPlayer) {
                myPlayer = currentTableState.players.find(p => p.id === myPlayerId);
            }
            
            console.log('æ‰¾åˆ°æˆ‘çš„ç©å®¶ä¿¡æ¯:', myPlayer);
            console.log('å½“å‰åº”è¯¥è¡ŒåŠ¨çš„ç©å®¶ID:', currentTableState.current_player_id);
            console.log('æˆ‘çš„æœ€æ–°ç©å®¶ID:', myPlayerId);
            console.log('æ‰€æœ‰ç©å®¶IDæ˜ å°„:', currentTableState.players.map(p => ({ id: p.id, name: p.nickname })));
            
            // åªæœ‰å½“è½®åˆ°æˆ‘è¡ŒåŠ¨æ—¶æ‰æ˜¾ç¤ºæŒ‰é’®
            console.log('ğŸ” è¯¦ç»†æ£€æŸ¥è½®æ¬¡æ¡ä»¶:', {
                myPlayer: myPlayer,
                myPlayerStatus: myPlayer ? myPlayer.status : 'null',
                currentPlayerId: currentTableState.current_player_id,
                myPlayerId: myPlayer ? myPlayer.id : 'null',
                statusMatch: myPlayer ? myPlayer.status === 'playing' : false,
                idMatch: myPlayer ? currentTableState.current_player_id === myPlayer.id : false
            });
            
            if (myPlayer && myPlayer.status === 'playing' && currentTableState.current_player_id === myPlayer.id) {
                const canCheck = currentTableState.current_bet === (myPlayer.current_bet || 0);
                const callAmount = currentTableState.current_bet - (myPlayer.current_bet || 0);
                console.log('ğŸ® è½®åˆ°æˆ‘è¡ŒåŠ¨:', { canCheck, callAmount, currentBet: currentTableState.current_bet, myBet: myPlayer.current_bet });
                showActionButtons(canCheck, callAmount);
            } else {
                console.log('âŒ ä¸æ˜¯æˆ‘çš„è½®æ¬¡:', { 
                    isMyTurn: currentTableState.current_player_id === (myPlayer ? myPlayer.id : myPlayerId),
                    currentPlayerId: currentTableState.current_player_id,
                    myPlayerId: myPlayer ? myPlayer.id : myPlayerId,
                    myStatus: myPlayer ? myPlayer.status : 'æ‰¾ä¸åˆ°ç©å®¶'
                });
                hideActionButtons();
            }
        } else {
            console.log('âŒ æ¸¸æˆæœªå¼€å§‹æˆ–åœ¨ç­‰å¾…çŠ¶æ€');
            hideActionButtons();
        }
        console.log('=== æ£€æŸ¥å®Œæ¯• ===');
    }

    function createCardElement(card, isBack = false) {
        console.log('createCardElement è°ƒç”¨ï¼Œå‚æ•°:', { card, isBack });
        const cardDiv = document.createElement('div');
        cardDiv.className = 'w-16 h-24 rounded-lg border-2 flex items-center justify-center text-lg font-bold';
        
        if (isBack || !card) {
            // ç‰ŒèƒŒé¢
            cardDiv.className += ' bg-blue-600 border-blue-400 text-white';
            cardDiv.textContent = 'ğŸ‚ ';
            console.log('åˆ›å»ºç‰ŒèƒŒé¢');
        } else {
            // ç‰Œæ­£é¢ - å¤„ç† card.to_dict() æ ¼å¼
            const suit = card.suit;
            const rank = card.rank;
            console.log('ç‰Œæ­£é¢æ•°æ®:', { suit, rank });
            
            const isRed = suit === 'â™¥' || suit === 'â™¦';
            cardDiv.className += ` bg-white border-gray-300 ${isRed ? 'text-red-500' : 'text-black'}`;
            cardDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-sm">${rank}</div>
                    <div class="text-lg">${suit}</div>
                </div>
            `;
            console.log('åˆ›å»ºç‰Œæ­£é¢:', { rank, suit, isRed });
        }
        
        return cardDiv;
    }

    // æ“ä½œè®°å½•ç›¸å…³å‡½æ•°
    function addActionLog(playerName, action, amount, description) {
        const timestamp = new Date().toLocaleTimeString();
        const actionText = getActionText(action, amount, description);
        
        const logEntry = {
            timestamp,
            playerName,
            action,
            amount,
            text: actionText
        };
        
        actionLog.push(logEntry);
        
        // é™åˆ¶è®°å½•æ•°é‡ï¼Œæœ€å¤šä¿ç•™50æ¡
        if (actionLog.length > 50) {
            actionLog.shift();
        }
        
        updateActionLogDisplay();
    }

    function getActionText(action, amount, description) {
        if (description) {
            return description;
        }
        
        const actionTexts = {
            'fold': 'å¼ƒç‰Œ',
            'check': 'è¿‡ç‰Œ',
            'call': `è·Ÿæ³¨ $${amount}`,
            'bet': `ä¸‹æ³¨ $${amount}`,
            'raise': `åŠ æ³¨åˆ° $${amount}`,
            'all_in': 'å…¨ä¸‹'
        };
        
        return actionTexts[action] || action;
    }

    function updateActionLogDisplay() {
        const logContainer = document.getElementById('actionLog');
        
        if (actionLog.length === 0) {
            logContainer.innerHTML = '<div class="text-gray-500">æš‚æ— æ“ä½œè®°å½•</div>';
            return;
        }
        
        // æ˜¾ç¤ºæœ€è¿‘çš„è®°å½•ï¼ˆå€’åºï¼‰
        const recentLogs = actionLog.slice(-20).reverse();
        
        logContainer.innerHTML = recentLogs.map(log => `
            <div class="mb-1 border-b border-gray-600 pb-1">
                <span class="text-gray-400 text-xs">${log.timestamp}</span>
                <span class="text-white font-medium">${log.playerName}</span>
                <span class="text-gray-300">${log.text}</span>
            </div>
        `).join('');
        
        // è‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ˆæœ€æ–°è®°å½•ï¼‰
        logContainer.scrollTop = 0;
    }

    function clearActionLog() {
        actionLog = [];
        updateActionLogDisplay();
    }

    // ä¸‹ä¸€è½®æŠ•ç¥¨ç›¸å…³å‡½æ•°
    function voteNextRound() {
        console.log('æŠ•ç¥¨å¼€å§‹ä¸‹ä¸€è½®');
        socket.emit('vote_next_round', { table_id: tableId });
        
        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
        const btn = document.getElementById('voteNextRoundBtn');
        btn.disabled = true;
        btn.textContent = 'å·²æŠ•ç¥¨';
        btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
        btn.classList.add('bg-gray-600');
    }

    function handleShowNextRoundVote(data) {
        console.log('æ˜¾ç¤ºä¸‹ä¸€è½®æŠ•ç¥¨:', data);
        
        // éšè—æ“ä½œæŒ‰é’®
        hideActionButtons();
        
        // æ˜¾ç¤ºæŠ•ç¥¨åŒºåŸŸ
        const voteArea = document.getElementById('nextRoundVote');
        voteArea.classList.remove('hidden');
        
        // é‡ç½®æŠ•ç¥¨æŒ‰é’®
        const btn = document.getElementById('voteNextRoundBtn');
        btn.disabled = false;
        btn.textContent = 'å¼€å§‹ä¸‹ä¸€è½®';
        btn.classList.remove('bg-gray-600');
        btn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
        
        // æ›´æ–°çŠ¶æ€
        document.getElementById('voteStatus').textContent = data.message || 'ç­‰å¾…ç©å®¶æŠ•ç¥¨...';
    }

    function handleNextRoundVoteUpdate(data) {
        console.log('æŠ•ç¥¨çŠ¶æ€æ›´æ–°:', data);
        
        const voteStatus = document.getElementById('voteStatus');
        const votedPlayers = document.getElementById('votedPlayers');
        
        voteStatus.textContent = `æŠ•ç¥¨è¿›åº¦: ${data.votes}/${data.required}`;
        votedPlayers.textContent = `å·²æŠ•ç¥¨: ${data.players_voted.join(', ')}`;
    }

    function handleNewHandStarted(data) {
        console.log('æ–°æ‰‹ç‰Œå¼€å§‹:', data);
        
        // éšè—æŠ•ç¥¨åŒºåŸŸ
        const voteArea = document.getElementById('nextRoundVote');
        voteArea.classList.add('hidden');
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        currentTableState = data;
        updateTableDisplay();
        
        // æ¸…ç†æ“ä½œè®°å½•ï¼ˆæ–°æ‰‹ç‰Œå¼€å§‹ï¼‰
        clearActionLog();
        addActionLog('ç³»ç»Ÿ', 'new_hand', 0, 'æ–°æ‰‹ç‰Œå¼€å§‹');
        
        showNotification('æ–°æ‰‹ç‰Œå¼€å§‹ï¼', 'success');
        
        // æ£€æŸ¥æ˜¯å¦è½®åˆ°æˆ‘è¡ŒåŠ¨
        setTimeout(() => checkIfMyTurn(), 500);
    }
    
    function handleBotThinking(data) {
        console.log('ğŸ¤– æ”¶åˆ°æœºå™¨äººæ€è€ƒäº‹ä»¶:', data);
        console.log('  - bot_name:', data.bot_name);
        console.log('  - bot_level:', data.bot_level); 
        console.log('  - thinking_time:', data.thinking_time);
        
        // æ˜¾ç¤ºæœºå™¨äººæ€è€ƒæç¤º
        const levelText = {
            'beginner': 'åˆçº§',
            'intermediate': 'ä¸­çº§', 
            'advanced': 'é«˜çº§',
            'god': 'ğŸ”®å¾·å·ä¹‹ç¥'
        };
        
        const levelDisplay = levelText[data.bot_level] || data.bot_level;
        const message = `ğŸ¤– ${data.bot_name} (${levelDisplay}) æ­£åœ¨æ€è€ƒ... (${data.thinking_time}ç§’)`;
        console.log('ğŸ“¢ æ˜¾ç¤ºé€šçŸ¥:', message);
        
        showNotification(message, 'info', data.thinking_time * 1000);
        
        // åœ¨æ“ä½œè®°å½•ä¸­æ·»åŠ æ€è€ƒçŠ¶æ€
        addActionLog(data.bot_name, 'thinking', 0, `æ­£åœ¨æ€è€ƒ (${levelDisplay})`);
    }
    

    
    // æŸ¥çœ‹ä¸ªäººå†å²è®°å½•
    function viewPlayerHistory() {
        if (!myPlayerId) {
            showNotification('è¯·å…ˆç™»å½•æ‰èƒ½æŸ¥çœ‹å†å²è®°å½•', 'error');
            return;
        }
        
        console.log('ğŸ“Š æŸ¥çœ‹ç©å®¶å†å²è®°å½•:', myPlayerId);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const statsDiv = document.getElementById('playerStats');
        statsDiv.innerHTML = '<div class="text-yellow-400">ğŸ”„ åŠ è½½å†å²è®°å½•ä¸­...</div>';
        
        // è·å–ç©å®¶æ‘Šç‰Œå†å²å’Œç»Ÿè®¡
        Promise.all([
            fetch(`/api/player_showdown_summary/${myPlayerId}`).then(r => r.json()),
            fetch(`/api/player_showdown_history/${myPlayerId}?limit=10`).then(r => r.json())
        ]).then(([summaryData, historyData]) => {
            if (summaryData.success && historyData.success) {
                displayPlayerHistory(summaryData, historyData);
            } else {
                statsDiv.innerHTML = '<div class="text-red-400">âŒ åŠ è½½å†å²è®°å½•å¤±è´¥</div>';
            }
        }).catch(error => {
            console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
            statsDiv.innerHTML = '<div class="text-red-400">âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</div>';
        });
    }
    
    function displayPlayerHistory(summaryData, historyData) {
        const statsDiv = document.getElementById('playerStats');
        
        if (!summaryData.has_data) {
            statsDiv.innerHTML = '<div class="text-gray-400">ğŸ® è¿˜æ²¡æœ‰æ‘Šç‰Œè®°å½•ï¼Œå¼€å§‹æ¸¸æˆæ¥åˆ›å»ºå†å²å§ï¼</div>';
            return;
        }
        
        const stats = summaryData.overall_stats;
        const history = historyData.history || [];
        
        // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯HTML
        const statsHTML = `
            <div class="space-y-2">
                <!-- åŸºæœ¬ç»Ÿè®¡ -->
                <div class="bg-gray-600 rounded p-3">
                    <h4 class="text-white font-semibold mb-2">ğŸ“ˆ æ€»ä½“ç»Ÿè®¡</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>æ‘Šç‰Œæ¬¡æ•°: <span class="text-yellow-400 font-bold">${stats.total_showdowns}</span></div>
                        <div>èƒœç‡: <span class="text-green-400 font-bold">${stats.win_rate}%</span></div>
                        <div>è·èƒœ: <span class="text-green-400">${stats.wins}</span></div>
                        <div>å¤±è´¥: <span class="text-red-400">${stats.losses}</span></div>
                        <div>æ€»å¥–é‡‘: <span class="text-yellow-400">$${stats.total_winnings}</span></div>
                        <div>å¹³å‡å¥–é‡‘: <span class="text-blue-400">$${stats.average_winnings}</span></div>
                    </div>
                </div>
                
                <!-- æ‰‹ç‰Œç±»å‹åˆ†å¸ƒ -->
                ${summaryData.hand_type_distribution && summaryData.hand_type_distribution.length > 0 ? `
                    <div class="bg-gray-600 rounded p-3">
                        <h4 class="text-white font-semibold mb-2">ğŸƒ å¸¸è§æ‰‹ç‰Œç±»å‹</h4>
                        <div class="space-y-1 text-xs">
                            ${summaryData.hand_type_distribution.slice(0, 5).map(hand => `
                                <div class="flex justify-between">
                                    <span class="text-gray-300">${hand.hand_type}</span>
                                    <span class="text-yellow-400">${hand.count}æ¬¡ (${hand.percentage}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- æœ€è¿‘å†å²è®°å½• -->
                ${history.length > 0 ? `
                    <div class="bg-gray-600 rounded p-3">
                        <h4 class="text-white font-semibold mb-2">ğŸ“‹ æœ€è¿‘æ‘Šç‰Œè®°å½•</h4>
                        <div class="max-h-40 overflow-y-auto space-y-2 text-xs">
                            ${history.slice(0, 5).map(record => {
                                const result = record.my_result && record.my_result.result === 'winner' ? 'ğŸ† èƒœ' : 'ğŸ’” è´Ÿ';
                                const resultColor = record.my_result && record.my_result.result === 'winner' ? 'text-green-400' : 'text-red-400';
                                const myCards = record.my_result ? record.my_result.hole_cards : [];
                                const myHand = record.my_result ? record.my_result.hand_description : '';
                                const myRank = record.my_result ? `#${record.my_result.rank_position}` : '';
                                const winnings = record.my_result ? record.my_result.winnings : 0;
                                
                                return `
                                    <div class="border-b border-gray-500 pb-2">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <span class="${resultColor} font-bold">${result}</span>
                                                <span class="text-gray-300">${myRank}</span>
                                                ${winnings > 0 ? `<span class="text-yellow-400">+$${winnings}</span>` : ''}
                                            </div>
                                            <span class="text-gray-400 text-xs">
                                                ${new Date(record.ended_at).toLocaleDateString()}
                                            </span>
                                        </div>
                                        <div class="text-gray-300 mt-1">
                                            æ‰‹ç‰Œ: ${myCards.map(c => `${c.rank}${c.suit}`).join(' ')}
                                        </div>
                                        <div class="text-blue-400">${myHand}</div>
                                        ${record.opponents.length > 0 ? `
                                            <div class="text-gray-500 text-xs mt-1">
                                                å¯¹æ‰‹: ${record.opponents.slice(0, 2).map(op => 
                                                    `${op.is_bot ? 'ğŸ¤–' : 'ğŸ‘¤'}${op.nickname}`
                                                ).join(', ')}${record.opponents.length > 2 ? '...' : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button onclick="showDetailedHistory()" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-xs w-full">
                            æŸ¥çœ‹è¯¦ç»†å†å²
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
        
        statsDiv.innerHTML = statsHTML;
    }
    
    function showDetailedHistory() {
        if (!myPlayerId) return;
        
        // è·å–è¯¦ç»†å†å²è®°å½•å’Œç»Ÿè®¡æ‘˜è¦
        Promise.all([
            fetch(`/api/player_showdown_history/${myPlayerId}?limit=30`).then(r => r.json()),
            fetch(`/api/player_showdown_summary/${myPlayerId}`).then(r => r.json())
        ]).then(([historyData, summaryData]) => {
            if (historyData.success && summaryData.success) {
                // åˆå¹¶æ•°æ®
                const combinedData = {
                    nickname: summaryData.nickname,
                    overall_stats: summaryData.overall_stats,
                    history: historyData.history
                };
                displayDetailedHistoryModal(combinedData);
            } else {
                showNotification('è·å–è¯¦ç»†å†å²å¤±è´¥', 'error');
            }
        }).catch(error => {
            console.error('è·å–è¯¦ç»†å†å²å¤±è´¥:', error);
            showNotification('è·å–è¯¦ç»†å†å²å¤±è´¥', 'error');
        });
    }
    
    function displayDetailedHistoryModal(data) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">ğŸ“Š ${data.nickname} çš„è¯¦ç»†æ‘Šç‰Œå†å²</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                
                <!-- ç»Ÿè®¡æ‘˜è¦ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-yellow-400">${data.overall_stats.total_showdowns}</div>
                        <div class="text-sm text-gray-300">æ€»æ‘Šç‰Œæ¬¡æ•°</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-green-400">${data.overall_stats.win_rate}%</div>
                        <div class="text-sm text-gray-300">èƒœç‡</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-blue-400">$${data.overall_stats.total_winnings}</div>
                        <div class="text-sm text-gray-300">æ€»å¥–é‡‘</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-purple-400">$${data.overall_stats.average_winnings}</div>
                        <div class="text-sm text-gray-300">å¹³å‡å¥–é‡‘</div>
                    </div>
                </div>
                
                <!-- å†å²è®°å½•åˆ—è¡¨ -->
                <div class="space-y-3">
                    ${data.history.map(record => {
                        const result = record.my_result && record.my_result.result === 'winner' ? 'ğŸ† èƒœåˆ©' : 'ğŸ’” å¤±è´¥';
                        const resultColor = record.my_result && record.my_result.result === 'winner' ? 'text-green-400' : 'text-red-400';
                        const myCards = record.my_result ? record.my_result.hole_cards : [];
                        const myHand = record.my_result ? record.my_result.hand_description : '';
                        const myRank = record.my_result ? `#${record.my_result.rank_position}` : '';
                        const winnings = record.my_result ? record.my_result.winnings : 0;
                        
                        return `
                            <div class="bg-gray-700 rounded p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="${resultColor} font-bold">${result}</span>
                                        <span class="text-gray-300">æ’å #${myRank}</span>
                                        ${winnings > 0 ? `<span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">+$${winnings}</span>` : ''}
                                    </div>
                                    <span class="text-gray-400 text-sm">
                                        ${new Date(record.ended_at).toLocaleString()}
                                    </span>
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-white font-semibold mb-1">æˆ‘çš„æ‰‹ç‰Œ:</div>
                                        <div class="flex gap-1 mb-2">
                                            ${myCards.map(card => `
                                                <div class="bg-white rounded px-2 py-1 text-black text-sm font-bold">
                                                    ${card.rank}${card.suit}
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="text-blue-400 font-medium">${myHand}</div>
                                    </div>
                                    
                                    <div>
                                        <div class="text-white font-semibold mb-1">å¯¹æ‰‹æƒ…å†µ:</div>
                                        <div class="space-y-1 text-sm">
                                            ${record.opponents.map(opponent => `
                                                <div class="flex justify-between">
                                                    <span class="text-gray-300">
                                                        ${opponent.is_bot ? 'ğŸ¤–' : 'ğŸ‘¤'} ${opponent.nickname}
                                                    </span>
                                                    <span class="text-gray-400">
                                                        #${opponent.rank_position} ${opponent.hand_description}
                                                    </span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function refreshGameState() {
        console.log('ğŸ”„ åˆ·æ–°æ¸¸æˆçŠ¶æ€...');
        
        const stateInfo = document.getElementById('gameStateInfo');
        
        if (!currentTableState) {
            stateInfo.innerHTML = '<div class="text-red-400">âŒ æ— æ¸¸æˆçŠ¶æ€</div>';
            return;
        }
        
        const myPlayer = currentTableState.players ? currentTableState.players.find(p => 
            p.nickname === currentPlayer.nickname && !p.is_bot
        ) : null;
        
        const stateHTML = `
            <div class="space-y-1">
                <div><strong>æ¸¸æˆé˜¶æ®µ:</strong> <span class="text-yellow-400">${currentTableState.game_stage || 'unknown'}</span></div>
                <div><strong>å½“å‰ç©å®¶:</strong> <span class="text-green-400">${currentTableState.current_player_id || 'none'}</span></div>
                <div><strong>æˆ‘çš„ID:</strong> <span class="text-blue-400">${myPlayerId || 'none'}</span></div>
                <div><strong>æˆ‘çš„æ˜µç§°:</strong> <span class="text-blue-400">${currentPlayer ? currentPlayer.nickname : 'none'}</span></div>
                <div><strong>æ‰¾åˆ°æˆ‘çš„ç©å®¶:</strong> <span class="text-${myPlayer ? 'green' : 'red'}-400">${myPlayer ? 'âœ…' : 'âŒ'}</span></div>
                ${myPlayer ? `
                    <div><strong>æˆ‘çš„çŠ¶æ€:</strong> <span class="text-purple-400">${myPlayer.status}</span></div>
                    <div><strong>æˆ‘çš„ç­¹ç :</strong> <span class="text-green-400">$${myPlayer.chips}</span></div>
                    <div><strong>æˆ‘çš„å½“å‰ä¸‹æ³¨:</strong> <span class="text-yellow-400">$${myPlayer.current_bet || 0}</span></div>
                ` : ''}
                <div><strong>å½“å‰ä¸‹æ³¨:</strong> <span class="text-orange-400">$${currentTableState.current_bet || 0}</span></div>
                <div><strong>åº•æ± :</strong> <span class="text-green-400">$${currentTableState.pot || 0}</span></div>
                <div><strong>è½®åˆ°æˆ‘è¡ŒåŠ¨:</strong> <span class="text-${myPlayer && currentTableState.current_player_id === myPlayer.id ? 'green' : 'red'}-400">
                    ${myPlayer && currentTableState.current_player_id === myPlayer.id ? 'âœ… æ˜¯' : 'âŒ å¦'}
                </span></div>
                <div><strong>å¯ä»¥å¼€å§‹æ¸¸æˆ:</strong> <span class="text-${currentTableState.can_start ? 'green' : 'red'}-400">
                    ${currentTableState.can_start ? 'âœ… æ˜¯' : 'âŒ å¦'}
                </span></div>
            </div>
        `;
        
        stateInfo.innerHTML = stateHTML;
        
        // åŒæ—¶è°ƒç”¨æ£€æŸ¥è½®æ¬¡
        checkIfMyTurn();
    }

    // ğŸµ éŸ³ä¹é›†æˆï¼šç¦»å¼€é¡µé¢æ—¶çš„éŸ³ä¹å¤„ç†
    window.addEventListener('beforeunload', function() {
        if (window.musicPlayer) {
            // å¦‚æœè¦ç¦»å¼€æ¸¸æˆæ¡Œï¼Œåˆ‡æ¢å›å¤§å…éŸ³ä¹
            musicPlayer.switchToTrack('lobby');
        }
    });

    // ğŸµ éŸ³ä¹é›†æˆï¼šç›‘å¬ç¦»å¼€ç‰Œæ¡ŒæŒ‰é’®
    document.getElementById('leaveTableBtn').addEventListener('click', function() {
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('lobby');
        }
    });

    // ğŸµ éŸ³ä¹å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
        // æŒ‰ M é”®åˆ‡æ¢éŸ³ä¹æ’­æ”¾/æš‚åœ
        if (e.key.toLowerCase() === 'm' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
            // ç¡®ä¿ä¸åœ¨è¾“å…¥æ¡†ä¸­
            if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                if (window.musicPlayer) {
                    musicPlayer.toggle();
                    showNotification(
                        musicPlayer.isPlaying ? 'ğŸµ éŸ³ä¹å·²å¼€å¯' : 'ğŸ”‡ éŸ³ä¹å·²æš‚åœ', 
                        'info', 1000
                    );
                }
            }
        }
        // æŒ‰ Ctrl+M æ‰“å¼€éŸ³ä¹è®¾ç½®
        else if (e.key.toLowerCase() === 'm' && e.ctrlKey) {
            e.preventDefault();
            if (window.musicPlayer) {
                musicPlayer.showSettings();
            }
        }
    });

</script>
{% endblock %} 