{% extends "base.html" %}

{% block title %}德州扑克游戏 - 牌桌{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 py-4">
    <div class="max-w-7xl mx-auto px-4">
        <!-- 牌桌信息栏 -->
        <div class="bg-gray-800 rounded-xl p-4 mb-4 border border-gray-700">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-white" id="tableTitle">牌桌</h1>
                    <p class="text-gray-300 text-sm">
                        <span id="gameModeInfo">盲注: <span id="blindInfo">10/20</span></span> | 
                        底池: <span id="potAmount">0</span> | 
                        手牌: <span id="handNumber">0</span>
                    </p>
                </div>
                <div class="flex space-x-2">
                    <button id="startHandBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm hidden">
                        开始游戏
                    </button>
                    <button id="addBotBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                        🤖 添加机器人
                    </button>
                    <button id="leaveTableBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                        离开牌桌
                    </button>
                </div>
            </div>
        </div>

        <!-- 游戏区域 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <!-- 公共牌区域 -->
            <div class="text-center mb-8">
                <h3 class="text-lg font-semibold text-white mb-4">公共牌</h3>
                <div id="communityCards" class="flex justify-center space-x-2 mb-4">
                    <!-- 公共牌将在这里显示 -->
                </div>
                <div class="text-xl font-bold text-yellow-400">
                    底池: $<span id="potDisplay">0</span>
                </div>
            </div>

            <!-- 玩家区域 -->
            <div id="playersArea" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <!-- 玩家信息将在这里显示 -->
            </div>

            <!-- 您的手牌 -->
            <div class="bg-gray-700 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-semibold text-white mb-2">您的手牌</h3>
                <div id="myCards" class="flex space-x-2">
                    <!-- 手牌将在这里显示 -->
                </div>
            </div>

            <!-- 操作按钮 -->
            <div id="actionButtons" class="bg-gray-700 rounded-lg p-4 hidden">
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="foldBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        弃牌
                    </button>
                    <button id="checkBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded hidden">
                        过牌
                    </button>
                    <button id="callBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded hidden">
                        跟注 $<span id="callAmount">0</span>
                    </button>
                    <button id="betBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">
                        下注
                    </button>
                    <button id="raiseBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded hidden">
                        加注
                    </button>
                    <button id="allinBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                        全下
                    </button>
                </div>
                
                <!-- 下注输入 -->
                <div id="betInputArea" class="mt-4 text-center hidden">
                    <input 
                        type="number" 
                        id="betAmount" 
                        class="bg-gray-600 text-white px-3 py-2 rounded mr-2"
                        placeholder="输入金额"
                        min="1"
                    >
                    <button id="confirmBetBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        确认
                    </button>
                    <button id="cancelBetBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        取消
                    </button>
                </div>
            </div>

            <!-- 下一轮投票区域 -->
            <div id="nextRoundVote" class="bg-yellow-600 rounded-lg p-4 mt-4 hidden">
                <h3 class="text-lg font-semibold text-white mb-2">准备开始下一轮？</h3>
                <div class="mb-3">
                    <p class="text-white text-sm" id="voteStatus">等待玩家投票...</p>
                    <div class="text-xs text-yellow-100 mt-1" id="votedPlayers"></div>
                </div>
                <button id="voteNextRoundBtn" class="bg-white hover:bg-gray-100 text-yellow-600 px-6 py-2 rounded font-bold transition-colors w-full">
                    开始下一轮
                </button>
            </div>

            <!-- 游戏状态调试 -->
            <div class="bg-gray-700 rounded-lg p-4 mt-4">
                <h3 class="text-lg font-semibold text-white mb-2">游戏状态 
                    <button id="refreshStateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs ml-2">
                        刷新
                    </button>
                </h3>
                <div id="gameStateInfo" class="text-sm text-gray-300">
                    <div class="text-gray-500">点击刷新查看状态</div>
                </div>
            </div>

            <!-- 操作记录 -->
            <div class="bg-gray-700 rounded-lg p-4 mt-4">
                <h3 class="text-lg font-semibold text-white mb-2">操作记录</h3>
                <div id="actionLog" class="max-h-40 overflow-y-auto text-sm text-gray-300">
                    <div class="text-gray-500">暂无操作记录</div>
                </div>
            </div>

            <!-- 个人历史记录 -->
            <div class="bg-gray-700 rounded-lg p-4 mt-4">
                <h3 class="text-lg font-semibold text-white mb-2">个人记录
                    <button id="viewHistoryBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm ml-2">
                        📊 查看历史
                    </button>
                </h3>
                <div id="playerStats" class="text-sm text-gray-300">
                    <div class="text-gray-500">点击查看历史记录加载个人统计</div>
                </div>
            </div>


        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let tableId = '{{ table_id }}';
    let currentTableState = null;
    let myPlayerId = null;
    let actionLog = [];

    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎯 DOMContentLoaded 事件触发');
        
        // 检查玩家登录状态
        const savedPlayer = localStorage.getItem('poker_player');
        if (!savedPlayer) {
            console.log('❌ 没有找到玩家信息，重定向到首页');
            location.href = '/';
            return;
        }

        console.log('✅ 找到玩家信息:', savedPlayer);
        currentPlayer = JSON.parse(savedPlayer);
        myPlayerId = currentPlayer.id;
        updatePlayerInfo();

        // 测试Socket连接
        console.log('🔌 Socket状态:', socket ? 'socket对象存在' : 'socket对象不存在');
        console.log('🔌 Socket连接状态:', socket ? socket.connected : 'N/A');

        // 初始化事件监听
        console.log('📡 初始化事件监听器...');
        initEventListeners();
        
        // 连接到牌桌
        console.log('🚀 页面初始化，玩家信息:', { myPlayerId, currentPlayer });
        connectToTable();
        
        // 测试玩家显示区域
        const playersArea = document.getElementById('playersArea');
        console.log('👥 玩家显示区域:', playersArea ? '存在' : '不存在');
        if (playersArea) {
            console.log('👥 玩家显示区域HTML:', playersArea.innerHTML);
            
            // 手动测试显示机器人
            setTimeout(() => {
                console.log('🧪 手动测试显示机器人...');
                const testPlayers = [
                    { id: 'test1', nickname: 'hyq', chips: 1000, is_bot: false, status: 'waiting' },
                    { id: 'test2', nickname: '🤖 新手1', chips: 1000, is_bot: true, status: 'waiting' },
                    { id: 'test3', nickname: '🤖 老司机2', chips: 1000, is_bot: true, status: 'waiting' }
                ];
                
                displayPlayers(testPlayers);
            }, 2000);
        }

        // 检查是否 test 账号，显示胜率计算器按钮
        if (currentPlayer && currentPlayer.nickname === 'test') {
            const btn = document.createElement('button');
            btn.id = 'winProbBtn';
            btn.textContent = '胜率计算器';
            btn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg ml-2';
            btn.onclick = function() {
                btn.disabled = true;
                btn.textContent = '计算中...';
                fetch('/api/win_probability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_id: tableId, player_id: myPlayerId })
                })
                .then(r => r.json())
                .then(res => {
                    btn.disabled = false;
                    btn.textContent = '胜率计算器';
                    if (res.success && res.data) {
                        alert(`胜率: ${(res.data.win * 100).toFixed(1)}%\n平局: ${(res.data.tie * 100).toFixed(1)}%\n失败: ${(res.data.lose * 100).toFixed(1)}%`);
                    } else {
                        alert(res.message || '无法计算胜率');
                    }
                })
                .catch(() => {
                    btn.disabled = false;
                    btn.textContent = '胜率计算器';
                    alert('网络错误');
                });
            };
            // 假设有操作区div id为tableActions，否则插入body
            const actions = document.getElementById('tableActions') || document.body;
            actions.appendChild(btn);
        }

        // 检查是否 test 账号，显示记牌助手按钮
        if (currentPlayer && currentPlayer.nickname === 'test') {
            const btnHelper = document.createElement('button');
            btnHelper.id = 'cardHelperBtn';
            btnHelper.textContent = '记牌助手';
            btnHelper.className = 'bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg ml-2';
            btnHelper.onclick = function() {
                btnHelper.disabled = true;
                btnHelper.textContent = '加载中...';
                fetch('/api/card_tracking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_id: tableId, player_id: myPlayerId })
                })
                .then(r => r.json())
                .then(res => {
                    btnHelper.disabled = false;
                    btnHelper.textContent = '记牌助手';
                    if (res.success && res.data) {
                        const known = res.data.known_cards.map(c => `${c.rank}${c.suit}`).join(' ');
                        const remain = res.data.remaining_cards;
                        let remainStr = '';
                        if (remain) {
                            remainStr = `\n剩余牌数: ${remain.total_remaining}\n花色: ${Object.entries(remain.suits).map(([s, n]) => `${s}:${n}`).join(' ')}\n点数: ${Object.entries(remain.ranks).map(([r, n]) => `${r}:${n}`).join(' ')}`;
                        }
                        alert(`已知牌: ${known || '无'}${remainStr}`);
                    } else {
                        alert(res.message || '无法获取记牌信息');
                    }
                })
                .catch(() => {
                    btnHelper.disabled = false;
                    btnHelper.textContent = '记牌助手';
                    alert('网络错误');
                });
            };
            const actions = document.getElementById('tableActions') || document.body;
            actions.appendChild(btnHelper);
        }
    });

    function initEventListeners() {
        // 按钮事件
        document.getElementById('startHandBtn').addEventListener('click', startHand);
        document.getElementById('addBotBtn').addEventListener('click', addBot);
        document.getElementById('leaveTableBtn').addEventListener('click', leaveTable);
        
        // 游戏动作按钮
        document.getElementById('foldBtn').addEventListener('click', () => playerAction('fold'));
        document.getElementById('checkBtn').addEventListener('click', () => playerAction('check'));
        document.getElementById('callBtn').addEventListener('click', () => playerAction('call'));
        document.getElementById('betBtn').addEventListener('click', showBetInput);
        document.getElementById('raiseBtn').addEventListener('click', showRaiseInput);
        document.getElementById('allinBtn').addEventListener('click', () => playerAction('all_in'));
        
        // 下注相关
        document.getElementById('confirmBetBtn').addEventListener('click', confirmBet);
        document.getElementById('cancelBetBtn').addEventListener('click', hideBetInput);
        
        // 下一轮投票
        document.getElementById('voteNextRoundBtn').addEventListener('click', voteNextRound);
        
        // 刷新状态按钮
        document.getElementById('refreshStateBtn').addEventListener('click', refreshGameState);
        
        // 查看历史记录按钮
        document.getElementById('viewHistoryBtn').addEventListener('click', viewPlayerHistory);

        // Socket事件监听
        socket.on('table_joined', handleTableJoined);
        socket.on('hand_started', handleHandStarted);
        socket.on('your_cards', handleYourCards);
        socket.on('your_turn', handleYourTurn);
        socket.on('action_processed', handleActionProcessed);
        socket.on('table_updated', handleTableUpdated);
        socket.on('player_joined', handlePlayerJoined);
        socket.on('bot_added', handleBotAdded);
        socket.on('player_left', handlePlayerLeft);
        socket.on('hand_complete', handleHandComplete);
        socket.on('hand_ended', handleHandEnded);
        socket.on('new_hand_started', handleNewHandStarted);
        socket.on('waiting_for_players', handleWaitingForPlayers);
        
        // 调试：监听所有Socket.IO事件
        const originalEmit = socket.emit;
        socket.emit = function(event, ...args) {
            console.log('🔺 发送事件:', event, args);
            return originalEmit.apply(this, [event, ...args]);
        };
        
        // 监听所有接收到的事件
        socket.onAny((eventName, ...args) => {
            console.log('🔻 接收事件:', eventName, args);
        });
        
        // 下一轮投票相关事件
        socket.on('show_next_round_vote', handleShowNextRoundVote);
        socket.on('next_round_vote_update', handleNextRoundVoteUpdate);
        socket.on('new_hand_started', handleNewHandStarted);
        
        // 机器人思考事件
        socket.on('bot_thinking', handleBotThinking);
    }

    function connectToTable() {
        // 检查是否有完整的玩家信息
        if (!myPlayerId || !currentPlayer || !currentPlayer.nickname) {
            showNotification('缺少玩家信息，请重新登录', 'error');
            setTimeout(() => location.href = '/', 2000);
            return;
        }
        
        console.log('🔗 开始连接到牌桌...', { tableId, myPlayerId, nickname: currentPlayer.nickname });
        
        // 监听连接成功事件
        socket.on('connect', function() {
            console.log('✅ WebSocket连接成功');
            registerAndJoinTable();
        });
        
        // 监听连接断开事件
        socket.on('disconnect', function(reason) {
            console.log('🔌 WebSocket连接断开:', reason);
            showNotification('连接断开，正在重连...', 'warning');
        });
        
        // 监听重连事件
        socket.on('reconnect', function(attemptNumber) {
            console.log('🔄 WebSocket重连成功，尝试次数:', attemptNumber);
            showNotification('重连成功！', 'success');
            registerAndJoinTable();
        });
        
        // 监听重连尝试
        socket.on('reconnect_attempt', function(attemptNumber) {
            console.log('🔄 正在尝试重连...', attemptNumber);
        });
        
        // 监听重连失败
        socket.on('reconnect_failed', function() {
            console.log('❌ 重连失败');
            showNotification('连接失败，请刷新页面', 'error');
        });
        
        // 如果已经连接，直接注册
        if (socket.connected) {
            console.log('✅ WebSocket已连接，直接注册');
            registerAndJoinTable();
        } else {
            console.log('⏳ Socket未连接，等待连接...');
        }
        
        // 监听错误
        socket.on('error', function(data) {
            console.error('❌ 连接错误:', data);
            showNotification(data.message || '连接错误', 'error');
        });

        // 监听玩家不存在错误
        socket.on('player_not_found', function(data) {
            showNotification(data.message || '玩家不存在', 'error');
            showNotification('正在重定向到主页...', 'info');
            setTimeout(() => {
                location.href = '/';
            }, 2000);
        });
    }
    
    function registerAndJoinTable() {
        console.log('📝 注册玩家会话...');
        
        // 先注册玩家会话，发送完整的玩家信息
        socket.emit('register_player', { 
            player_id: myPlayerId,
            nickname: currentPlayer.nickname
        });
        
        // 监听注册结果
        socket.on('player_registered', function(data) {
            console.log('📝 玩家注册结果:', data);
            if (data.success) {
                console.log('🚪 加入牌桌房间...');
                // 注册成功后加入牌桌房间
                socket.emit('join_table', { table_id: tableId });
                
                // 添加超时检查，如果3秒内没有收到table_joined事件，就手动请求牌桌状态
                setTimeout(() => {
                    if (!currentTableState) {
                        console.log('⚠️  3秒内未收到table_joined事件，手动请求牌桌状态');
                        socket.emit('get_table_state', { table_id: tableId });
                    }
                }, 3000);
            } else {
                showNotification('注册失败，请重新进入', 'error');
                setTimeout(() => location.href = '/lobby', 2000);
            }
        });
        
        // 添加超时处理
        setTimeout(() => {
            if (!currentTableState) {
                console.log('⏰ 连接超时，尝试重新加入...');
                socket.emit('join_table', { table_id: tableId });
            }
        }, 3000);
    }

    function startHand() {
        socket.emit('start_hand');
    }

    function addBot() {
        // 创建一个简单的选择菜单
        const botLevels = [
            { value: 'beginner', name: '初级机器人', desc: '随机策略，适合新手练习' },
            { value: 'intermediate', name: '中级机器人', desc: '蒙特卡洛策略，有一定技巧' },
            { value: 'advanced', name: '高级机器人', desc: '复杂策略，会诈唬和分析' },
            { value: 'god', name: '德州扑克之神', desc: '🔮 能看到所有手牌的作弊AI，绝对强大' }
        ];
        
        let optionText = '选择机器人等级：\n\n';
        botLevels.forEach((bot, index) => {
            optionText += `${index + 1}. ${bot.name} - ${bot.desc}\n`;
        });
        optionText += '\n输入数字 1-4 选择机器人等级：';
        
        const choice = prompt(optionText);
        const choiceNum = parseInt(choice);
        
        if (choiceNum >= 1 && choiceNum <= 4) {
            const selectedLevel = botLevels[choiceNum - 1].value;
            socket.emit('add_bot', { level: selectedLevel });
        }
    }

    function leaveTable() {
        if (confirm('确定要离开牌桌吗？')) {
            socket.emit('leave_table');
            location.href = '/lobby';
        }
    }

    function playerAction(action, amount = 0) {
        console.log('执行玩家动作:', { action, amount, playerId: myPlayerId });
        socket.emit('player_action', {
            action: action,
            amount: amount
        });
        hideActionButtons();
    }

    function showBetInput() {
        document.getElementById('betInputArea').classList.remove('hidden');
        document.getElementById('betAmount').focus();
        document.getElementById('betAmount').placeholder = '输入下注金额';
    }

    function showRaiseInput() {
        document.getElementById('betInputArea').classList.remove('hidden');
        document.getElementById('betAmount').focus();
        document.getElementById('betAmount').placeholder = '输入加注金额';
        // 设置最小加注额
        if (currentTableState) {
            const myPlayer = currentTableState.players.find(p => p.id === myPlayerId);
            const minRaise = currentTableState.current_bet + currentTableState.big_blind;
            document.getElementById('betAmount').min = minRaise;
            document.getElementById('betAmount').placeholder = `最小加注: $${minRaise}`;
        }
    }

    function hideBetInput() {
        document.getElementById('betInputArea').classList.add('hidden');
        document.getElementById('betAmount').value = '';
    }

    function confirmBet() {
        const amount = parseInt(document.getElementById('betAmount').value);
        if (amount && amount > 0) {
            // 简化逻辑：根据当前投注情况决定是下注还是加注
            if (currentTableState && currentTableState.current_bet > 0) {
                // 如果已有下注，则进行加注
                playerAction('raise', amount);
            } else {
                // 如果没有下注，则进行下注
                playerAction('bet', amount);
            }
            hideBetInput();
        }
    }

    function hideActionButtons() {
        document.getElementById('actionButtons').classList.add('hidden');
    }

    function showActionButtons(canCheck, callAmount) {
        const actionButtons = document.getElementById('actionButtons');
        const checkBtn = document.getElementById('checkBtn');
        const callBtn = document.getElementById('callBtn');
        const betBtn = document.getElementById('betBtn');
        const raiseBtn = document.getElementById('raiseBtn');
        const allinBtn = document.getElementById('allinBtn');
        const foldBtn = document.getElementById('foldBtn');
        const callAmountSpan = document.getElementById('callAmount');

        actionButtons.classList.remove('hidden');

        // 基本操作：弃牌和全下总是可用
        foldBtn.classList.remove('hidden');
        allinBtn.classList.remove('hidden');

        if (canCheck) {
            // 可以过牌时，显示过牌和下注
            checkBtn.classList.remove('hidden');
            callBtn.classList.add('hidden');
            betBtn.classList.remove('hidden');
            raiseBtn.classList.add('hidden');
        } else {
            // 需要跟注时，显示跟注和加注
            checkBtn.classList.add('hidden');
            callBtn.classList.remove('hidden');
            callAmountSpan.textContent = callAmount;
            betBtn.classList.add('hidden');
            raiseBtn.classList.remove('hidden');
        }
    }

    // Socket事件处理函数
    function handleTableJoined(data) {
        console.log('🚪 收到table_joined事件:', data);
        if (data.success) {
            currentTableState = data.table;
            
            // 调试：检查玩家数据
            if (currentTableState && currentTableState.players) {
                console.log('📊 牌桌玩家数据:', currentTableState.players);
                const botCount = currentTableState.players.filter(p => p.is_bot).length;
                const humanCount = currentTableState.players.filter(p => !p.is_bot).length;
                console.log(`🤖 机器人数量: ${botCount}, 👤 人类玩家: ${humanCount}`);
            }
            
            // 同步玩家ID（特别重要在重连时）
            const synced = syncPlayerIdWithBackend(data.table);
            
            updateTableDisplay();
            
            if (data.reconnected) {
                showNotification('🔗 重新连接成功！', 'success');
                // 重连后立即检查是否轮到我行动
                setTimeout(() => checkIfMyTurn(), synced ? 600 : 500);
            } else {
                showNotification('成功加入牌桌！', 'success');
                if (synced) {
                    setTimeout(() => checkIfMyTurn(), 100);
                } else {
                    checkIfMyTurn();
                }
            }
        }
    }

    function handleHandStarted(data) {
        console.log('游戏开始事件:', data);
        currentTableState = data.table;
        
        // 🎵 音乐集成：手牌开始时切换到游戏桌音乐
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('table');
        }
        
        // 清空我的手牌显示
        document.getElementById('myCards').innerHTML = '';
        
        // 清空操作记录
        clearActionLog();
        addActionLog('系统', 'game_start', 0, `🎮 第${data.table.hand_number}手开始`);
        
        // 同步玩家ID
        const synced = syncPlayerIdWithBackend(data.table);
        
        updateTableDisplay();
        showNotification('🎮 新手牌开始！等待发牌...', 'info');
        
        // 隐藏操作按钮，等待手牌
        hideActionButtons();
        
        // 检查是否轮到我行动
        setTimeout(() => checkIfMyTurn(), synced ? 600 : 500);
    }

    function handleYourCards(data) {
        console.log('收到手牌:', data.hole_cards);
        console.log('手牌详细信息:', JSON.stringify(data.hole_cards, null, 2));
        displayMyCards(data.hole_cards);
        showNotification('📋 手牌已发放！', 'success');
    }

    function handleYourTurn(data) {
        console.log('轮到你了:', data);
        
        // 🎵 音乐集成：轮到我行动时播放紧张音乐
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('action');
        }
        
        // 检查玩家是否有筹码
        const myPlayer = currentTableState ? currentTableState.players.find(p => p.id === myPlayerId) : null;
        if (!myPlayer || myPlayer.chips <= 0 || myPlayer.status === 'broke') {
            console.log('玩家没有筹码，成为观察者，不显示操作按钮');
            showNotification('💸 您没有筹码了，只能观察游戏', 'info', 3000);
            hideActionButtons();
            return;
        }
        
        const canCheck = data.current_bet === 0 || data.current_bet <= (data.your_bet || 0);
        const callAmount = Math.max(0, data.current_bet - (data.your_bet || 0));
        
        showActionButtons(canCheck, callAmount);
        showNotification('轮到您行动了', 'info', 2000);
        addActionLog('系统', 'your_turn', 0, '轮到您行动');
    }

    function handleActionProcessed(data) {
        currentTableState = data.table;
        
        // 🎵 音乐集成：根据动作类型播放音效
        if (window.musicPlayer && data.action) {
            // 如果是我的动作完成，切换回平静音乐
            if (data.player_id === myPlayerId) {
                musicPlayer.switchToTrack('table');
            }
            // 如果有大额下注或全下，播放紧张音乐
            else if ((data.action === 'bet' || data.action === 'raise') && data.amount >= 100) {
                musicPlayer.switchToTrack('action');
            }
            else if (data.action === 'allin') {
                musicPlayer.switchToTrack('action');
            }
        }
        
        // 记录操作
        if (data.action && data.player_id) {
            const player = data.table.players.find(p => p.id === data.player_id);
            const playerName = player ? player.nickname : '未知玩家';
            addActionLog(playerName, data.action, data.amount || 0, data.description);
        }
        
        // 同步玩家ID
        const synced = syncPlayerIdWithBackend(data.table);
        
        updateTableDisplay();
        
        // 如果轮到我行动，显示操作按钮
        if (synced) {
            setTimeout(() => checkIfMyTurn(), 100);
        } else {
            checkIfMyTurn();
        }
    }

    function handleTableUpdated(data) {
        currentTableState = data;
        
        // 强制同步玩家ID - 检查是否需要更新
        const synced = syncPlayerIdWithBackend(data);
        
        updateTableDisplay();
        
        // 如果进行了ID同步，延迟一下再检查轮次，确保同步生效
        if (synced) {
            setTimeout(() => checkIfMyTurn(), 100);
        } else {
            checkIfMyTurn();
        }
    }

    function handlePlayerJoined(data) {
        currentTableState = data.table;
        updateTableDisplay();
        
        // 如果是机器人加入，显示通知
        if (data.player && data.player.is_bot) {
            showNotification(`🤖 机器人 ${data.player.nickname} 已加入牌桌`, 'success');
            
            // 如果现在有2个或更多玩家，提示可以开始游戏
            if (currentTableState.can_start) {
                showNotification('🎮 现在可以开始游戏了！', 'success');
            }
        }
    }

    function handleBotAdded(data) {
        if (data.success) {
            // 更新牌桌状态 - 需要重新获取完整状态
            if (data.table) {
                currentTableState = data.table;
            }
            updateTableDisplay();
            showNotification(`🤖 机器人 ${data.bot.nickname} 已加入牌桌`, 'success');
            
            // 如果现在可以开始游戏，显示提示
            if (currentTableState && currentTableState.players && currentTableState.players.length >= 2) {
                showNotification('🎮 现在可以开始游戏了！点击"开始游戏"按钮', 'info');
            }
        } else {
            showNotification('添加机器人失败', 'error');
        }
    }

    function handlePlayerLeft(data) {
        console.log('玩家离开:', data);
        showNotification(`👋 ${data.nickname} 离开了牌桌`, 'info');
        
        // 重新获取牌桌状态
        // 这里我们需要触发一个状态更新
        setTimeout(() => {
            // 简单的方式：重新加载页面
            location.reload();
        }, 1000);
    }

    function handleHandComplete(data) {
        console.log('游戏结束:', data);
        
        // 显示获胜者信息
        if (data.winner) {
            showNotification(`🎉 ${data.winner.nickname} 获胜！赢得 $${data.final_pot}`, 'success', 5000);
            addActionLog('系统', 'hand_end', data.final_pot, `🎉 ${data.winner.nickname} 获胜，赢得 $${data.final_pot}`);
        }
        
        // 隐藏操作按钮
        hideActionButtons();
        
        // 显示倒计时信息
        showNotification('⏰ 1秒后自动开始下一局...', 'info', 2000);
    }

    function handleHandEnded(data) {
        console.log('🏆 手牌结束:', data);
        
        // 🎵 音乐集成：手牌结束时切换回平静的游戏桌音乐
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('table');
        }
        
        // 调试：检查摊牌数据
        console.log('🃏 摊牌数据检查:');
        console.log('  - showdown_info存在:', !!data.showdown_info);
        console.log('  - is_showdown:', data.showdown_info?.is_showdown);
        console.log('  - showdown_players数量:', data.showdown_info?.showdown_players?.length || 0);
        if (data.showdown_info?.showdown_players) {
            data.showdown_info.showdown_players.forEach((player, i) => {
                console.log(`  - 玩家${i+1}: ${player.nickname} - ${player.hand_description}`);
            });
        }
        
        // 更新桌面状态（包含更新后的筹码）
        if (data.table_state) {
            console.log('📊 更新游戏状态，包含最新筹码信息');
            currentTableState = data.table_state;
            updateTableDisplay();
        }
        
        // 显示获胜者信息
        if (data.winners && data.winners.length > 0) {
            const winner = data.winners[0];
            const pot = currentTableState ? currentTableState.pot : 0;
            showNotification(`🎉 ${winner.nickname} 获胜！赢得 $${pot}`, 'success', 5000);
            addActionLog('系统', 'hand_end', pot, `🎉 ${winner.nickname} 获胜，赢得 $${pot}`);
            
            // 如果我是获胜者，特别提示筹码增加
            if (winner.nickname === currentPlayer.nickname) {
                const myPlayer = currentTableState.players.find(p => p.id === myPlayerId);
                if (myPlayer) {
                    showNotification(`💰 恭喜！您现在有 $${myPlayer.chips} 筹码`, 'success', 3000);
                }
            }
        }
        
        // 摊牌信息显示逻辑优化 - 放宽显示条件
        console.log('🃏 摊牌数据完整检查:');
        console.log('  - showdown_info存在:', !!data.showdown_info);
        console.log('  - is_showdown:', data.showdown_info?.is_showdown);
        console.log('  - showdown_players数量:', data.showdown_info?.showdown_players?.length || 0);
        console.log('  - winners数量:', data.winners?.length || 0);
        
        // 优化后的显示条件：优先显示摊牌详情，包括单人获胜的情况
        if (data.showdown_info && data.showdown_info.showdown_players && data.showdown_info.showdown_players.length > 0) {
            console.log('✅ 显示完整摊牌详情（包括单人获胜）');
            showShowdownDetails(data.showdown_info);
        } else if (data.showdown_info && data.showdown_info.community_cards && data.showdown_info.community_cards.length > 0) {
            console.log('✅ 显示基础摊牌信息');
            showShowdownDetails(data.showdown_info);
        } else if (data.winners && data.winners.length > 0) {
            console.log('✅ 显示获胜者信息（包括弃牌获胜）');
            showSimpleWinnerInfo(data.winners);
        } else {
            console.log('❌ 没有可显示的获胜信息');
            // 即使没有具体获胜者数据，也应该显示基本的手牌结束提示
            if (data.message) {
                console.log('📢 显示手牌结束消息');
                showNotification(data.message, 'success', 5000);
            }
        }
        
        // 显示消息
        if (data.message) {
            showNotification(data.message, 'info', 3000);
        }
        
        // 隐藏操作按钮
        hideActionButtons();
        
        // 清空我的手牌显示
        document.getElementById('myCards').innerHTML = '';
    }

    function showShowdownDetails(showdownInfo) {
        console.log('🃏 显示摊牌详情:', showdownInfo);
        
        // 判断是否为弃牌获胜
        const isFoldWin = showdownInfo.win_reason === 'others_folded';
        const title = isFoldWin ? '🏆 获胜结果（其他玩家弃牌）' : '🃏 摊牌结果';
        
        // 创建摊牌详情弹窗
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">${title}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                ${isFoldWin ? '<div class="mb-4 p-3 bg-green-800 rounded-lg"><p class="text-green-200 text-center">🎉 您通过加注让所有对手弃牌获胜！</p></div>' : ''}
                
                <!-- 公共牌显示 -->
                ${showdownInfo.community_cards && showdownInfo.community_cards.length > 0 ? `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-300 mb-2">🎴 公共牌</h4>
                    <div class="flex gap-2">
                        ${showdownInfo.community_cards.map(card => {
                            const isRed = card.suit === '♥' || card.suit === '♦';
                            const textColor = isRed ? 'text-red-500' : 'text-black';
                            return `<div class="bg-white rounded-lg p-2 text-center min-w-[40px] shadow-md">
                                <div class="text-lg font-bold ${textColor}">
                                    <div class="text-sm">${card.rank}</div>
                                    <div class="text-lg">${card.suit}</div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>` : ''}
                
                <!-- 玩家摊牌详情 -->
                ${showdownInfo.showdown_players && showdownInfo.showdown_players.length > 0 ? `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-300">🏆 玩家排名</h4>
                    ${showdownInfo.showdown_players.map((player, index) => {
                        const rankEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                        const playerType = player.is_bot ? '🤖' : '👤';
                        const resultColor = player.result === 'winner' ? 'text-green-400' : 'text-gray-400';
                        
                        return `
                            <div class="bg-gray-700 rounded-lg p-4 border ${player.result === 'winner' ? 'border-green-500' : 'border-gray-600'}">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">${rankEmoji}</span>
                                        <span class="text-lg font-semibold text-white">${playerType} ${player.nickname}</span>
                                        <span class="${resultColor} font-medium">
                                            ${player.result === 'winner' ? `赢得 $${player.winnings}` : '败北'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-4">
                                    <!-- 底牌 -->
                                    <div class="flex gap-1">
                                        ${player.hole_cards.map(card => {
                                            const isRed = card.suit === '♥' || card.suit === '♦';
                                            const textColor = isRed ? 'text-red-500' : 'text-black';
                                            return `<div class="bg-white rounded p-1 text-center min-w-[35px] text-sm shadow">
                                                <div class="font-bold ${textColor}">
                                                    <div class="text-xs">${card.rank}</div>
                                                    <div class="text-sm">${card.suit}</div>
                                                </div>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                    
                                    <!-- 箭头 -->
                                    <span class="text-gray-400">→</span>
                                    
                                    <!-- 牌型 -->
                                    <div class="flex-1">
                                        <span class="text-yellow-400 font-semibold">${player.hand_description}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>` : ''}
                
                <div class="mt-6 text-center">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        确定
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // 3秒后显示关闭提示
        setTimeout(() => {
            const hint = document.createElement('div');
            hint.className = 'absolute top-2 right-2 bg-yellow-600 text-white px-2 py-1 rounded text-sm';
            hint.textContent = '点击确定或背景关闭';
            modal.querySelector('.bg-gray-800').appendChild(hint);
            
            setTimeout(() => hint.remove(), 2000);
        }, 3000);
        
        // 点击背景关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function showSimpleWinnerInfo(winners) {
        console.log('🏆 显示简化获胜者信息:', winners);
        
        // 创建简化获胜者信息弹窗
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        
        let winnersHtml = '';
        winners.forEach((winner, index) => {
            winnersHtml += `
                <div class="mb-4 p-4 bg-green-800 rounded-lg">
                    <div class="text-lg font-bold text-green-200 mb-2">
                        🏆 获胜者: ${winner.nickname}
                    </div>
                    <div class="text-green-300 mb-2">
                        获得奖金: $${winner.amount || 0}
                    </div>
                    ${winner.hole_cards && winner.hole_cards.length > 0 ? `
                        <div class="text-sm text-green-400 mb-2">获胜手牌:</div>
                        <div class="flex space-x-2 justify-center mb-2">
                            ${winner.hole_cards.map(card => {
                                const isRed = card.suit === '♥' || card.suit === '♦';
                                const textColor = isRed ? 'text-red-500' : 'text-black';
                                return `<div class="bg-white rounded border border-gray-300 w-12 h-16 flex items-center justify-center text-xs font-bold ${textColor}">
                                    <div class="text-center">
                                        <div class="text-xs">${card.rank}</div>
                                        <div class="text-sm">${card.suit}</div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    ` : ''}
                    ${winner.hand_description ? `
                        <div class="text-yellow-300 text-sm font-semibold">
                            ${winner.hand_description}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border-2 border-green-500">
                <h3 class="text-xl font-bold text-white mb-4 text-center">🎉 手牌结束</h3>
                ${winnersHtml}
                <div class="text-center text-gray-400 text-sm mb-4">
                    ${winners.some(w => !w.hole_cards || w.hole_cards.length === 0) ? 
                        '🃏 其他玩家弃牌，无需摊牌' : 
                        '🃏 摊牌结果'
                    }
                </div>
                <button onclick="this.closest('.fixed').remove()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mt-4">
                    确定
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // 点击背景关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function handleNewHandStarted(data) {
        console.log('新一局开始:', data);
        showNotification(`🎮 ${data.message}`, 'success');
        
        // 清空我的手牌显示
        document.getElementById('myCards').innerHTML = '';
        
        // 等待更新的游戏状态
        setTimeout(() => {
            updateTableDisplay();
            checkIfMyTurn();
        }, 500);
    }

    function handleWaitingForPlayers(data) {
        console.log('等待玩家:', data);
        showNotification(`⏳ ${data.message}`, 'warning');
        hideActionButtons();
    }

    function updateTableDisplay() {
        if (!currentTableState) return;

        // 更新基本信息
        document.getElementById('tableTitle').textContent = currentTableState.title;
        // 更新游戏模式和盲注信息
        const gameModeInfo = document.getElementById('gameModeInfo');
        const blindInfo = document.getElementById('blindInfo');
        
        if (currentTableState.game_mode === 'ante') {
            const antePercentage = (currentTableState.ante_percentage * 100).toFixed(1);
            gameModeInfo.innerHTML = `⚖️ 按比例: <span id="blindInfo">${antePercentage}%</span>`;
        } else {
            gameModeInfo.innerHTML = `🎯 盲注: <span id="blindInfo">${currentTableState.small_blind}/${currentTableState.big_blind}</span>`;
        }
        document.getElementById('potAmount').textContent = currentTableState.pot;
        document.getElementById('potDisplay').textContent = currentTableState.pot;
        document.getElementById('handNumber').textContent = currentTableState.hand_number;
        
        // 显示当前行动玩家提示
        let statusText = '';
        if (currentTableState.current_player_id) {
            const currentPlayer = currentTableState.players.find(p => p.id === currentTableState.current_player_id);
            if (currentPlayer) {
                if (currentPlayer.id === myPlayerId) {
                    statusText = ' | 🔔 轮到您行动';
                } else {
                    statusText = ` | ⏳ 等待 ${currentPlayer.nickname} 行动`;
                }
            }
        }
        document.getElementById('tableTitle').textContent = currentTableState.title + statusText;

        // 更新公共牌
        displayCommunityCards(currentTableState.community_cards);
        
        // 更新玩家信息
        displayPlayers(currentTableState.players);
        
        // 检查是否可以开始游戏
        if (currentTableState.can_start) {
            document.getElementById('startHandBtn').classList.remove('hidden');
        } else {
            document.getElementById('startHandBtn').classList.add('hidden');
            
            // 如果只有一个玩家，显示提示
            if (currentTableState.players && currentTableState.players.length === 1) {
                showNotification('💡 提示：请添加机器人或等待其他玩家加入后开始游戏', 'info');
            }
        }
    }

    function displayCommunityCards(cards) {
        const container = document.getElementById('communityCards');
        container.innerHTML = '';
        
        for (let i = 0; i < 5; i++) {
            const cardDiv = document.createElement('div');
            if (i < cards.length) {
                cardDiv.appendChild(createCardElement(cards[i]));
            } else {
                cardDiv.appendChild(createCardElement(null, true));
            }
            container.appendChild(cardDiv);
        }
    }

    function displayPlayers(players) {
        console.log('👥 displayPlayers 被调用，玩家数据:', players);
        const container = document.getElementById('playersArea');
        container.innerHTML = '';

        players.forEach(player => {
            console.log(`处理玩家: ${player.nickname}, is_bot: ${player.is_bot}`);
            const playerDiv = document.createElement('div');
            
            // 判断是否是我：优先通过ID，其次通过昵称
            const isMe = (player.id === myPlayerId) || 
                        (currentPlayer && player.nickname === currentPlayer.nickname);
            const statusClass = player.status === 'playing' ? 'text-green-400' : 'text-gray-400';
            
            // 检查是否是当前行动的玩家
            const isCurrentPlayer = currentTableState && currentTableState.current_player_id === player.id;
            
            // 基础样式
            let bgClass = 'bg-gray-600';
            let borderClass = 'border-2 border-transparent';
            let extraClass = '';
            
            // 高亮当前行动的玩家 - 更强的视觉效果
            if (isCurrentPlayer && currentTableState.game_stage !== 'waiting') {
                if (player.is_bot) {
                    // 机器人轮次 - 橙色突出显示
                    bgClass = 'bg-orange-600';
                    borderClass = 'border-4 border-orange-300 shadow-xl shadow-orange-500/60';
                    extraClass = 'animate-pulse transform scale-105';
                } else {
                    // 人类玩家轮次 - 蓝色突出显示
                    bgClass = 'bg-blue-700';
                    borderClass = 'border-4 border-yellow-300 shadow-xl shadow-yellow-400/60';
                    extraClass = 'animate-pulse transform scale-105';
                }
            }
            
            // dealer玩家特殊背景 - 更明显的标识
            if (player.is_dealer) {
                if (!isCurrentPlayer || currentTableState.game_stage === 'waiting') {
                    bgClass = 'bg-red-700';
                    borderClass = 'border-3 border-red-300 shadow-lg shadow-red-400/50';
                    extraClass = 'transform scale-102';
                }
            }
            
            playerDiv.className = `${bgClass} ${borderClass} ${extraClass} rounded-lg p-3 transition-all duration-300`;
            
            playerDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-semibold ${isMe ? 'text-yellow-400' : 'text-white'}">
                            ${player.is_bot ? '🤖 ' : '👤 '}${player.nickname} ${isMe ? '(你)' : ''}
                            ${player.is_dealer ? ' <span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">🏛️ DEALER</span>' : ''}
                            ${isCurrentPlayer && currentTableState.game_stage !== 'waiting' ? 
                                player.is_bot ? ' <span class="bg-orange-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-bounce">🤖 机器人行动中</span>' 
                                : ' <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-bounce">🎯 你的回合</span>' 
                                : ''}
                        </div>
                        <div class="text-sm ${statusClass}">
                            ${getPlayerStatusDisplay(player)}${player.is_bot ? ' • <span class="text-cyan-400">机器人</span>' : ''}
                            ${player.is_dealer ? '<span class="text-red-300 font-bold bg-red-800/30 px-2 py-1 rounded"> • 庄家</span>' : ''}
                            ${player.is_small_blind ? '<span class="text-blue-300 bg-blue-800/30 px-1 py-0.5 rounded"> • 小盲</span>' : ''}
                            ${player.is_big_blind ? '<span class="text-orange-300 bg-orange-800/30 px-1 py-0.5 rounded"> • 大盲</span>' : ''}
                            ${isCurrentPlayer && currentTableState.game_stage !== 'waiting' ? 
                                player.is_bot ? '<span class="text-orange-200 font-bold bg-orange-600/50 px-2 py-1 rounded animate-pulse"> • 🤖 正在思考</span>'
                                : '<span class="text-green-200 font-bold bg-green-600/50 px-2 py-1 rounded animate-pulse"> • ⚡ 轮到你了</span>'
                                : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-white font-semibold">$${player.chips}</div>
                        ${player.current_bet > 0 ? `<div class="text-yellow-400 text-sm">下注: $${player.current_bet}</div>` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(playerDiv);
        });
    }

    function displayMyCards(cards) {
        console.log('displayMyCards 调用，参数:', cards);
        const container = document.getElementById('myCards');
        container.innerHTML = '';
        
        if (cards && cards.length === 2) {
            console.log('正在显示2张手牌...');
            cards.forEach((card, index) => {
                console.log(`创建第${index + 1}张牌:`, card);
                const cardElement = createCardElement(card);
                console.log('创建的牌元素:', cardElement);
                container.appendChild(cardElement);
            });
            console.log('手牌显示完成，容器内容:', container.innerHTML);
        } else {
            console.log('手牌数据无效:', { cards, length: cards ? cards.length : 'null' });
        }
    }

    function getPlayerStatusDisplay(player) {
        let statusText = '';
        let statusClass = 'bg-gray-600';
        
        switch (player.status) {
            case 'waiting':
                statusText = '等待中';
                statusClass = 'bg-blue-600';
                break;
            case 'playing':
                statusText = '游戏中';
                statusClass = 'bg-green-600';
                break;
            case 'folded':
                statusText = '弃牌';
                statusClass = 'bg-red-600';
                break;
            case 'all_in':
                statusText = '全下';
                statusClass = 'bg-purple-600';
                break;
            case 'broke':
                statusText = '观察者 (无筹码)';
                statusClass = 'bg-gray-500';
                break;
            case 'disconnected':
                statusText = '断线';
                statusClass = 'bg-red-800';
                break;
            default:
                statusText = player.status;
        }
        
        return `<span class="${statusClass} text-white px-2 py-1 rounded text-xs">${statusText}</span>`;
    }

    function syncPlayerIdWithBackend(tableState) {
        if (!tableState || !tableState.players || !currentPlayer) {
            console.log('⚠️ syncPlayerIdWithBackend: 缺少必要数据', { tableState: !!tableState, players: !!tableState?.players, currentPlayer: !!currentPlayer });
            return;
        }
        
        console.log('🔍 检查玩家ID同步:', {
            myPlayerId: myPlayerId,
            nickname: currentPlayer.nickname,
                            allPlayers: tableState.players.map(p => ({ id: p.id, nickname: p.nickname, is_bot: p.is_bot }))
        });
        
        // 先通过昵称找到正确的玩家（因为昵称是可信的）
        const foundByNickname = tableState.players.find(p => 
            p.nickname === currentPlayer.nickname && !p.is_bot
        );
        
        if (foundByNickname) {
            // 检查ID是否匹配
            if (foundByNickname.id !== myPlayerId) {
                console.log('🔄 ID不匹配，正在同步:', {
                    旧ID: myPlayerId,
                    新ID: foundByNickname.id,
                    昵称: currentPlayer.nickname
                });
                
                // 更新前端的玩家ID
                myPlayerId = foundByNickname.id;
                
                // 更新localStorage
                localStorage.setItem('player_id', myPlayerId);
                currentPlayer.id = myPlayerId;
                localStorage.setItem('poker_player', JSON.stringify(currentPlayer));
                
                // 重新注册会话
                socket.emit('register_player', { player_id: myPlayerId });
                
                console.log('✅ 玩家ID已同步:', myPlayerId);
                return true; // 表示进行了同步
            } else {
                console.log('✅ 玩家ID匹配正确');
                return false; // 表示无需同步
            }
        } else {
            console.log('❌ 无法通过昵称找到匹配的玩家:', currentPlayer.nickname);
            console.log('所有非机器人玩家:', tableState.players.filter(p => !p.is_bot).map(p => p.nickname));
            return false;
        }
    }

    function checkIfMyTurn() {
        // 根据游戏状态判断是否显示操作按钮
        console.log('=== 检查我的轮次 ===');
        console.log('当前游戏状态:', currentTableState ? currentTableState.game_stage : '无状态');
        console.log('我的玩家ID:', myPlayerId);
        console.log('我的昵称:', currentPlayer ? currentPlayer.nickname : '无昵称');
        
        if (currentTableState && currentTableState.game_stage !== 'waiting') {
            // 强制通过昵称找到正确的玩家（确保使用最新的ID）
            let myPlayer = null;
            if (currentPlayer && currentPlayer.nickname) {
                myPlayer = currentTableState.players.find(p => 
                    p.nickname === currentPlayer.nickname && !p.is_bot
                );
                
                if (myPlayer && myPlayer.id !== myPlayerId) {
                    console.log('⚠️ 在checkIfMyTurn中发现ID不匹配，立即更新');
                    console.log('旧ID:', myPlayerId, '新ID:', myPlayer.id);
                    myPlayerId = myPlayer.id;  // 更新全局变量
                    // 同时更新localStorage
                    localStorage.setItem('player_id', myPlayerId);
                    const updatedPlayer = { ...currentPlayer, id: myPlayer.id };
                    localStorage.setItem('poker_player', JSON.stringify(updatedPlayer));
                    currentPlayer = updatedPlayer;
                }
            }
            
            // 如果通过昵称没找到，再尝试通过ID找
            if (!myPlayer) {
                myPlayer = currentTableState.players.find(p => p.id === myPlayerId);
            }
            
            console.log('找到我的玩家信息:', myPlayer);
            console.log('当前应该行动的玩家ID:', currentTableState.current_player_id);
            console.log('我的最新玩家ID:', myPlayerId);
            console.log('所有玩家ID映射:', currentTableState.players.map(p => ({ id: p.id, name: p.nickname })));
            
            // 只有当轮到我行动时才显示按钮
            console.log('🔍 详细检查轮次条件:', {
                myPlayer: myPlayer,
                myPlayerStatus: myPlayer ? myPlayer.status : 'null',
                currentPlayerId: currentTableState.current_player_id,
                myPlayerId: myPlayer ? myPlayer.id : 'null',
                statusMatch: myPlayer ? myPlayer.status === 'playing' : false,
                idMatch: myPlayer ? currentTableState.current_player_id === myPlayer.id : false
            });
            
            if (myPlayer && myPlayer.status === 'playing' && currentTableState.current_player_id === myPlayer.id) {
                const canCheck = currentTableState.current_bet === (myPlayer.current_bet || 0);
                const callAmount = currentTableState.current_bet - (myPlayer.current_bet || 0);
                console.log('🎮 轮到我行动:', { canCheck, callAmount, currentBet: currentTableState.current_bet, myBet: myPlayer.current_bet });
                showActionButtons(canCheck, callAmount);
            } else {
                console.log('❌ 不是我的轮次:', { 
                    isMyTurn: currentTableState.current_player_id === (myPlayer ? myPlayer.id : myPlayerId),
                    currentPlayerId: currentTableState.current_player_id,
                    myPlayerId: myPlayer ? myPlayer.id : myPlayerId,
                    myStatus: myPlayer ? myPlayer.status : '找不到玩家'
                });
                hideActionButtons();
            }
        } else {
            console.log('❌ 游戏未开始或在等待状态');
            hideActionButtons();
        }
        console.log('=== 检查完毕 ===');
    }

    function createCardElement(card, isBack = false) {
        console.log('createCardElement 调用，参数:', { card, isBack });
        const cardDiv = document.createElement('div');
        cardDiv.className = 'w-16 h-24 rounded-lg border-2 flex items-center justify-center text-lg font-bold';
        
        if (isBack || !card) {
            // 牌背面
            cardDiv.className += ' bg-blue-600 border-blue-400 text-white';
            cardDiv.textContent = '🂠';
            console.log('创建牌背面');
        } else {
            // 牌正面 - 处理 card.to_dict() 格式
            const suit = card.suit;
            const rank = card.rank;
            console.log('牌正面数据:', { suit, rank });
            
            const isRed = suit === '♥' || suit === '♦';
            cardDiv.className += ` bg-white border-gray-300 ${isRed ? 'text-red-500' : 'text-black'}`;
            cardDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-sm">${rank}</div>
                    <div class="text-lg">${suit}</div>
                </div>
            `;
            console.log('创建牌正面:', { rank, suit, isRed });
        }
        
        return cardDiv;
    }

    // 操作记录相关函数
    function addActionLog(playerName, action, amount, description) {
        const timestamp = new Date().toLocaleTimeString();
        const actionText = getActionText(action, amount, description);
        
        const logEntry = {
            timestamp,
            playerName,
            action,
            amount,
            text: actionText
        };
        
        actionLog.push(logEntry);
        
        // 限制记录数量，最多保留50条
        if (actionLog.length > 50) {
            actionLog.shift();
        }
        
        updateActionLogDisplay();
    }

    function getActionText(action, amount, description) {
        if (description) {
            return description;
        }
        
        const actionTexts = {
            'fold': '弃牌',
            'check': '过牌',
            'call': `跟注 $${amount}`,
            'bet': `下注 $${amount}`,
            'raise': `加注到 $${amount}`,
            'all_in': '全下'
        };
        
        return actionTexts[action] || action;
    }

    function updateActionLogDisplay() {
        const logContainer = document.getElementById('actionLog');
        
        if (actionLog.length === 0) {
            logContainer.innerHTML = '<div class="text-gray-500">暂无操作记录</div>';
            return;
        }
        
        // 显示最近的记录（倒序）
        const recentLogs = actionLog.slice(-20).reverse();
        
        logContainer.innerHTML = recentLogs.map(log => `
            <div class="mb-1 border-b border-gray-600 pb-1">
                <span class="text-gray-400 text-xs">${log.timestamp}</span>
                <span class="text-white font-medium">${log.playerName}</span>
                <span class="text-gray-300">${log.text}</span>
            </div>
        `).join('');
        
        // 自动滚动到顶部（最新记录）
        logContainer.scrollTop = 0;
    }

    function clearActionLog() {
        actionLog = [];
        updateActionLogDisplay();
    }

    // 下一轮投票相关函数
    function voteNextRound() {
        console.log('投票开始下一轮');
        socket.emit('vote_next_round', { table_id: tableId });
        
        // 禁用按钮防止重复点击
        const btn = document.getElementById('voteNextRoundBtn');
        btn.disabled = true;
        btn.textContent = '已投票';
        btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
        btn.classList.add('bg-gray-600');
    }

    function handleShowNextRoundVote(data) {
        console.log('显示下一轮投票:', data);
        
        // 隐藏操作按钮
        hideActionButtons();
        
        // 显示投票区域
        const voteArea = document.getElementById('nextRoundVote');
        voteArea.classList.remove('hidden');
        
        // 重置投票按钮
        const btn = document.getElementById('voteNextRoundBtn');
        btn.disabled = false;
        btn.textContent = '开始下一轮';
        btn.classList.remove('bg-gray-600');
        btn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
        
        // 更新状态
        document.getElementById('voteStatus').textContent = data.message || '等待玩家投票...';
    }

    function handleNextRoundVoteUpdate(data) {
        console.log('投票状态更新:', data);
        
        const voteStatus = document.getElementById('voteStatus');
        const votedPlayers = document.getElementById('votedPlayers');
        
        voteStatus.textContent = `投票进度: ${data.votes}/${data.required}`;
        votedPlayers.textContent = `已投票: ${data.players_voted.join(', ')}`;
    }

    function handleNewHandStarted(data) {
        console.log('新手牌开始:', data);
        
        // 隐藏投票区域
        const voteArea = document.getElementById('nextRoundVote');
        voteArea.classList.add('hidden');
        
        // 更新游戏状态
        currentTableState = data;
        updateTableDisplay();
        
        // 清理操作记录（新手牌开始）
        clearActionLog();
        addActionLog('系统', 'new_hand', 0, '新手牌开始');
        
        showNotification('新手牌开始！', 'success');
        
        // 检查是否轮到我行动
        setTimeout(() => checkIfMyTurn(), 500);
    }
    
    function handleBotThinking(data) {
        console.log('🤖 收到机器人思考事件:', data);
        console.log('  - bot_name:', data.bot_name);
        console.log('  - bot_level:', data.bot_level); 
        console.log('  - thinking_time:', data.thinking_time);
        
        // 显示机器人思考提示
        const levelText = {
            'beginner': '初级',
            'intermediate': '中级', 
            'advanced': '高级',
            'god': '🔮德州之神'
        };
        
        const levelDisplay = levelText[data.bot_level] || data.bot_level;
        const message = `🤖 ${data.bot_name} (${levelDisplay}) 正在思考... (${data.thinking_time}秒)`;
        console.log('📢 显示通知:', message);
        
        showNotification(message, 'info', data.thinking_time * 1000);
        
        // 在操作记录中添加思考状态
        addActionLog(data.bot_name, 'thinking', 0, `正在思考 (${levelDisplay})`);
    }
    

    
    // 查看个人历史记录
    function viewPlayerHistory() {
        if (!myPlayerId) {
            showNotification('请先登录才能查看历史记录', 'error');
            return;
        }
        
        console.log('📊 查看玩家历史记录:', myPlayerId);
        
        // 显示加载状态
        const statsDiv = document.getElementById('playerStats');
        statsDiv.innerHTML = '<div class="text-yellow-400">🔄 加载历史记录中...</div>';
        
        // 获取玩家摊牌历史和统计
        Promise.all([
            fetch(`/api/player_showdown_summary/${myPlayerId}`).then(r => r.json()),
            fetch(`/api/player_showdown_history/${myPlayerId}?limit=10`).then(r => r.json())
        ]).then(([summaryData, historyData]) => {
            if (summaryData.success && historyData.success) {
                displayPlayerHistory(summaryData, historyData);
            } else {
                statsDiv.innerHTML = '<div class="text-red-400">❌ 加载历史记录失败</div>';
            }
        }).catch(error => {
            console.error('获取历史记录失败:', error);
            statsDiv.innerHTML = '<div class="text-red-400">❌ 网络错误，请重试</div>';
        });
    }
    
    function displayPlayerHistory(summaryData, historyData) {
        const statsDiv = document.getElementById('playerStats');
        
        if (!summaryData.has_data) {
            statsDiv.innerHTML = '<div class="text-gray-400">🎮 还没有摊牌记录，开始游戏来创建历史吧！</div>';
            return;
        }
        
        const stats = summaryData.overall_stats;
        const history = historyData.history || [];
        
        // 生成统计信息HTML
        const statsHTML = `
            <div class="space-y-2">
                <!-- 基本统计 -->
                <div class="bg-gray-600 rounded p-3">
                    <h4 class="text-white font-semibold mb-2">📈 总体统计</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>摊牌次数: <span class="text-yellow-400 font-bold">${stats.total_showdowns}</span></div>
                        <div>胜率: <span class="text-green-400 font-bold">${stats.win_rate}%</span></div>
                        <div>获胜: <span class="text-green-400">${stats.wins}</span></div>
                        <div>失败: <span class="text-red-400">${stats.losses}</span></div>
                        <div>总奖金: <span class="text-yellow-400">$${stats.total_winnings}</span></div>
                        <div>平均奖金: <span class="text-blue-400">$${stats.average_winnings}</span></div>
                    </div>
                </div>
                
                <!-- 手牌类型分布 -->
                ${summaryData.hand_type_distribution && summaryData.hand_type_distribution.length > 0 ? `
                    <div class="bg-gray-600 rounded p-3">
                        <h4 class="text-white font-semibold mb-2">🃏 常见手牌类型</h4>
                        <div class="space-y-1 text-xs">
                            ${summaryData.hand_type_distribution.slice(0, 5).map(hand => `
                                <div class="flex justify-between">
                                    <span class="text-gray-300">${hand.hand_type}</span>
                                    <span class="text-yellow-400">${hand.count}次 (${hand.percentage}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- 最近历史记录 -->
                ${history.length > 0 ? `
                    <div class="bg-gray-600 rounded p-3">
                        <h4 class="text-white font-semibold mb-2">📋 最近摊牌记录</h4>
                        <div class="max-h-40 overflow-y-auto space-y-2 text-xs">
                            ${history.slice(0, 5).map(record => {
                                const result = record.my_result && record.my_result.result === 'winner' ? '🏆 胜' : '💔 负';
                                const resultColor = record.my_result && record.my_result.result === 'winner' ? 'text-green-400' : 'text-red-400';
                                const myCards = record.my_result ? record.my_result.hole_cards : [];
                                const myHand = record.my_result ? record.my_result.hand_description : '';
                                const myRank = record.my_result ? `#${record.my_result.rank_position}` : '';
                                const winnings = record.my_result ? record.my_result.winnings : 0;
                                
                                return `
                                    <div class="border-b border-gray-500 pb-2">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <span class="${resultColor} font-bold">${result}</span>
                                                <span class="text-gray-300">${myRank}</span>
                                                ${winnings > 0 ? `<span class="text-yellow-400">+$${winnings}</span>` : ''}
                                            </div>
                                            <span class="text-gray-400 text-xs">
                                                ${new Date(record.ended_at).toLocaleDateString()}
                                            </span>
                                        </div>
                                        <div class="text-gray-300 mt-1">
                                            手牌: ${myCards.map(c => `${c.rank}${c.suit}`).join(' ')}
                                        </div>
                                        <div class="text-blue-400">${myHand}</div>
                                        ${record.opponents.length > 0 ? `
                                            <div class="text-gray-500 text-xs mt-1">
                                                对手: ${record.opponents.slice(0, 2).map(op => 
                                                    `${op.is_bot ? '🤖' : '👤'}${op.nickname}`
                                                ).join(', ')}${record.opponents.length > 2 ? '...' : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button onclick="showDetailedHistory()" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-xs w-full">
                            查看详细历史
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
        
        statsDiv.innerHTML = statsHTML;
    }
    
    function showDetailedHistory() {
        if (!myPlayerId) return;
        
        // 获取详细历史记录和统计摘要
        Promise.all([
            fetch(`/api/player_showdown_history/${myPlayerId}?limit=30`).then(r => r.json()),
            fetch(`/api/player_showdown_summary/${myPlayerId}`).then(r => r.json())
        ]).then(([historyData, summaryData]) => {
            if (historyData.success && summaryData.success) {
                // 合并数据
                const combinedData = {
                    nickname: summaryData.nickname,
                    overall_stats: summaryData.overall_stats,
                    history: historyData.history
                };
                displayDetailedHistoryModal(combinedData);
            } else {
                showNotification('获取详细历史失败', 'error');
            }
        }).catch(error => {
            console.error('获取详细历史失败:', error);
            showNotification('获取详细历史失败', 'error');
        });
    }
    
    function displayDetailedHistoryModal(data) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">📊 ${data.nickname} 的详细摊牌历史</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                
                <!-- 统计摘要 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-yellow-400">${data.overall_stats.total_showdowns}</div>
                        <div class="text-sm text-gray-300">总摊牌次数</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-green-400">${data.overall_stats.win_rate}%</div>
                        <div class="text-sm text-gray-300">胜率</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-blue-400">$${data.overall_stats.total_winnings}</div>
                        <div class="text-sm text-gray-300">总奖金</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3 text-center">
                        <div class="text-2xl font-bold text-purple-400">$${data.overall_stats.average_winnings}</div>
                        <div class="text-sm text-gray-300">平均奖金</div>
                    </div>
                </div>
                
                <!-- 历史记录列表 -->
                <div class="space-y-3">
                    ${data.history.map(record => {
                        const result = record.my_result && record.my_result.result === 'winner' ? '🏆 胜利' : '💔 失败';
                        const resultColor = record.my_result && record.my_result.result === 'winner' ? 'text-green-400' : 'text-red-400';
                        const myCards = record.my_result ? record.my_result.hole_cards : [];
                        const myHand = record.my_result ? record.my_result.hand_description : '';
                        const myRank = record.my_result ? `#${record.my_result.rank_position}` : '';
                        const winnings = record.my_result ? record.my_result.winnings : 0;
                        
                        return `
                            <div class="bg-gray-700 rounded p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="${resultColor} font-bold">${result}</span>
                                        <span class="text-gray-300">排名 #${myRank}</span>
                                        ${winnings > 0 ? `<span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">+$${winnings}</span>` : ''}
                                    </div>
                                    <span class="text-gray-400 text-sm">
                                        ${new Date(record.ended_at).toLocaleString()}
                                    </span>
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-white font-semibold mb-1">我的手牌:</div>
                                        <div class="flex gap-1 mb-2">
                                            ${myCards.map(card => `
                                                <div class="bg-white rounded px-2 py-1 text-black text-sm font-bold">
                                                    ${card.rank}${card.suit}
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="text-blue-400 font-medium">${myHand}</div>
                                    </div>
                                    
                                    <div>
                                        <div class="text-white font-semibold mb-1">对手情况:</div>
                                        <div class="space-y-1 text-sm">
                                            ${record.opponents.map(opponent => `
                                                <div class="flex justify-between">
                                                    <span class="text-gray-300">
                                                        ${opponent.is_bot ? '🤖' : '👤'} ${opponent.nickname}
                                                    </span>
                                                    <span class="text-gray-400">
                                                        #${opponent.rank_position} ${opponent.hand_description}
                                                    </span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function refreshGameState() {
        console.log('🔄 刷新游戏状态...');
        
        const stateInfo = document.getElementById('gameStateInfo');
        
        if (!currentTableState) {
            stateInfo.innerHTML = '<div class="text-red-400">❌ 无游戏状态</div>';
            return;
        }
        
        const myPlayer = currentTableState.players ? currentTableState.players.find(p => 
            p.nickname === currentPlayer.nickname && !p.is_bot
        ) : null;
        
        const stateHTML = `
            <div class="space-y-1">
                <div><strong>游戏阶段:</strong> <span class="text-yellow-400">${currentTableState.game_stage || 'unknown'}</span></div>
                <div><strong>当前玩家:</strong> <span class="text-green-400">${currentTableState.current_player_id || 'none'}</span></div>
                <div><strong>我的ID:</strong> <span class="text-blue-400">${myPlayerId || 'none'}</span></div>
                <div><strong>我的昵称:</strong> <span class="text-blue-400">${currentPlayer ? currentPlayer.nickname : 'none'}</span></div>
                <div><strong>找到我的玩家:</strong> <span class="text-${myPlayer ? 'green' : 'red'}-400">${myPlayer ? '✅' : '❌'}</span></div>
                ${myPlayer ? `
                    <div><strong>我的状态:</strong> <span class="text-purple-400">${myPlayer.status}</span></div>
                    <div><strong>我的筹码:</strong> <span class="text-green-400">$${myPlayer.chips}</span></div>
                    <div><strong>我的当前下注:</strong> <span class="text-yellow-400">$${myPlayer.current_bet || 0}</span></div>
                ` : ''}
                <div><strong>当前下注:</strong> <span class="text-orange-400">$${currentTableState.current_bet || 0}</span></div>
                <div><strong>底池:</strong> <span class="text-green-400">$${currentTableState.pot || 0}</span></div>
                <div><strong>轮到我行动:</strong> <span class="text-${myPlayer && currentTableState.current_player_id === myPlayer.id ? 'green' : 'red'}-400">
                    ${myPlayer && currentTableState.current_player_id === myPlayer.id ? '✅ 是' : '❌ 否'}
                </span></div>
                <div><strong>可以开始游戏:</strong> <span class="text-${currentTableState.can_start ? 'green' : 'red'}-400">
                    ${currentTableState.can_start ? '✅ 是' : '❌ 否'}
                </span></div>
            </div>
        `;
        
        stateInfo.innerHTML = stateHTML;
        
        // 同时调用检查轮次
        checkIfMyTurn();
    }

    // 🎵 音乐集成：离开页面时的音乐处理
    window.addEventListener('beforeunload', function() {
        if (window.musicPlayer) {
            // 如果要离开游戏桌，切换回大厅音乐
            musicPlayer.switchToTrack('lobby');
        }
    });

    // 🎵 音乐集成：监听离开牌桌按钮
    document.getElementById('leaveTableBtn').addEventListener('click', function() {
        if (window.musicPlayer) {
            musicPlayer.switchToTrack('lobby');
        }
    });

    // 🎵 音乐快捷键支持
    document.addEventListener('keydown', function(e) {
        // 按 M 键切换音乐播放/暂停
        if (e.key.toLowerCase() === 'm' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
            // 确保不在输入框中
            if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                if (window.musicPlayer) {
                    musicPlayer.toggle();
                    showNotification(
                        musicPlayer.isPlaying ? '🎵 音乐已开启' : '🔇 音乐已暂停', 
                        'info', 1000
                    );
                }
            }
        }
        // 按 Ctrl+M 打开音乐设置
        else if (e.key.toLowerCase() === 'm' && e.ctrlKey) {
            e.preventDefault();
            if (window.musicPlayer) {
                musicPlayer.showSettings();
            }
        }
    });

</script>
{% endblock %} 